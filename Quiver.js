// This file is generated from /src/Quiver-Dev.js and /src/functions/
// Quiver üèπ - Development Version
const currentVersion="1.5.2",SCRIPT_KEY="com.canva.quiver";ui.setTitle("Quiver"),ui.setBackgroundColor("#2d2d2d");
// quiver_utilities_checkVersion.js
var GITHUB_REPO="phillip-motion/Quiver",scriptName="Quiver";function compareVersions(v1,v2){for(var parts1=v1.split(".").map(function(n){return parseInt(n,10)||0}),parts2=v2.split(".").map(function(n){return parseInt(n,10)||0}),i=0;i<Math.max(parts1.length,parts2.length);i++){var num1=parts1[i]||0,num2=parts2[i]||0;if(num1>num2)return 1;if(num1<num2)return-1}return 0}function checkForUpdate(githubRepo,scriptName,currentVersion,callback){var oneDayAgo=(new Date).getTime()-864e5,shouldFetchFromGithub=!0,cachedLatestVersion=null;if(api.hasPreferenceObject(scriptName+"_update_check")){var prefs=api.getPreferenceObject(scriptName+"_update_check");cachedLatestVersion=prefs.latestVersion,prefs.lastCheck&&prefs.lastCheck>oneDayAgo&&(shouldFetchFromGithub=!1)}if(shouldFetchFromGithub||!cachedLatestVersion)try{var path="/"+githubRepo+"/main/versions.json",client=new api.WebClient("https://raw.githubusercontent.com");if(client.get(path),200===client.status()){var latestVersion=JSON.parse(client.body())[scriptName];if(!latestVersion)return console.warn("Version check: Script name '"+scriptName+"' not found in versions.json"),void(callback&&callback(!1));latestVersion.startsWith("v")&&(latestVersion=latestVersion.substring(1)),api.setPreferenceObject(scriptName+"_update_check",{lastCheck:(new Date).getTime(),latestVersion:latestVersion}),compareVersions(latestVersion,currentVersion)>0?(console.warn(scriptName+" "+latestVersion+" update available (you have "+currentVersion+"). Download at github.com/"+githubRepo),callback&&callback(!0,latestVersion)):callback&&callback(!1)}else console.log("Version check: Unable to fetch versions.json (HTTP "+client.status()+")"),callback&&callback(!1)}catch(e){console.log("Version check: Error - "+e.message),callback&&callback(!1)}else compareVersions(cachedLatestVersion,currentVersion)>0?(console.warn(scriptName+" "+cachedLatestVersion+" update available (you have "+currentVersion+"). Download at github.com/"+githubRepo),callback&&callback(!0,cachedLatestVersion)):callback&&callback(!1)}
// quiver_createUI.js
function createIconButton(symbol,tooltip,size){size=size||32;var btn=new ui.Button(symbol);return btn.setSize(size,size),tooltip&&btn.setToolTip(tooltip),btn}checkForUpdate(GITHUB_REPO,scriptName,"1.5.2");var pasteButton=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_text-paste.png");pasteButton.setImageSize(61,22),pasteButton.setMinimumHeight(36),pasteButton.setToolTip("Paste SVG content from clipboard"),pasteButton.onClick=function(){try{var svgCode="";try{svgCode=api.getClipboardText()}catch(clipboardError){return void console.error("Error accessing clipboard: "+clipboardError.toString())}if(!svgCode||""===(svgCode+"").trim())return void console.error("No content found in clipboard");if(!svgCode.includes("<svg")||!svgCode.includes("</svg>"))return void console.error("No valid SVG found in clipboard");if(autoSaveEnabled)console.info("Saving scene..."),saveSceneBeforeImport()?console.info("Scene saved. Parsing‚Ä¶"):console.error("Could not save. Parsing‚Ä¶");processAndImportSVG(svgCode)}catch(e){var errorMsg=e&&e.message?e.message:"Import failed";"undefined"!==errorMsg&&"null"!==errorMsg&&console.error("Error: "+errorMsg)}};var importFileButton=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_text-import.png");importFileButton.setImageSize(70,22),importFileButton.setMinimumHeight(36),importFileButton.setToolTip("Import SVG file from your computer"),importFileButton.onClick=function(){var startPath="";try{startPath=api.getProjectPath()||""}catch(e){}var filePath=api.presentOpenFile(startPath,"Select SVG file","SVG files (*.svg)");if(filePath&&""!==filePath)try{var fileContents=null;try{fileContents=api.readFromFile(filePath)}catch(readError){try{if(autoSaveEnabled)saveSceneBeforeImport();var importedLayers=api.convertSVGToLayers(filePath);if(importedLayers&&importedLayers.length>0)return void console.info("üèπ Import complete - "+importedLayers.length+" layers imported")}catch(convertError){}return void console.error("‚ùå Unable to read SVG file")}if(!fileContents||""===fileContents.trim())return void console.error("‚ùå File is empty");if(autoSaveEnabled)saveSceneBeforeImport()?console.info("Scene saved. Processing file..."):console.error("Could not save. Processing file...");processAndImportSVG(fileContents)}catch(error){console.error("‚ùå Error reading file")}else console.error("No file selected")};var statusLabel=new ui.Label("Ready to import");statusLabel.setMinimumHeight(20);var originalSetText=statusLabel.setText;statusLabel.setText=function(text){"Error: undefined"!==text&&"Error: null"!==text&&"undefined"!==text&&"null"!==text&&originalSetText.call(this,text)};var autoSaveEnabled=!0,keepOriginalEnabled=!1,defaultRadius="",importGradientsEnabled=!0,importLiveTextEnabled=!0,importImageryEnabled=!0,importEffectsEnabled=!0,imageFilterQuality=2,settingsButton=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_icon-settings.png");settingsButton.setImageSize(22,22),settingsButton.setSize(35,35),settingsButton.setToolTip("Settings");var convertRectButton=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_icon-rectangle.png");convertRectButton.setImageSize(22,22),convertRectButton.setSize(34,34),convertRectButton.setToolTip("Convert to Rectangle"),convertRectButton.onClick=function(evt){try{convertSelectionToRect(keepOriginalEnabled)}catch(e){}};var dynamicAlignButton=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_icon-align.png");dynamicAlignButton.setImageSize(22,22),dynamicAlignButton.setSize(34,34),dynamicAlignButton.setToolTip("Dynamic Align"),dynamicAlignButton.onClick=function(){try{var sel=null;try{sel=api.getSelection()}catch(e){sel=null}if(!sel||!sel.length)return void console.error("Select at least one layer");for(var applied=0,i=0;i<sel.length;i++)applyDynamicAlignToLayer(sel[i])&&applied++;console.info(applied?"Dynamic Align applied to "+applied+" layer(s)":"No valid layers for Dynamic Align")}catch(e){console.error("Dynamic Align error: "+e.message)}};var flattenShapeButton=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_icon-flatten.png");flattenShapeButton.setImageSize(22,22),flattenShapeButton.setSize(34,34),flattenShapeButton.setToolTip("Flatten Shape"),flattenShapeButton.onClick=function(){flattenShape()};var renamerInput=new ui.LineEdit;renamerInput.setMinimumHeight(36),renamerInput.setContentsMargins(6,6,6,6),renamerInput.setCornerRounding(4),renamerInput.setBackgroundColor(ui.getThemeColor("Window")),renamerInput.setPlaceholder("Rename layers...");var settingsWindow,renamerButton=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_icon-apply.png");function createSettingsWindow(){if(settingsWindow)return settingsWindow.close(),void(settingsWindow=null);(settingsWindow=new ui.Container).setMinimumWidth(350),settingsWindow.setMinimumHeight(520),settingsWindow.setBackgroundColor(ui.getThemeColor("Base"));var settingsLayout=new ui.VLayout;settingsLayout.setMargins(15,15,15,15),settingsLayout.setSpaceBetween(4);var titleLabel=new ui.Label("Settings");titleLabel.setTextColor(ui.getThemeColor("Light")),titleLabel.setFontSize(18),settingsLayout.add(titleLabel),settingsLayout.addSpacing(12);var autoSaveLayout=new ui.HLayout,autoSaveCheckbox=new ui.Checkbox(autoSaveEnabled);autoSaveEnabled?autoSaveCheckbox.setValue(!0):autoSaveCheckbox.setValue(!1),autoSaveCheckbox.onValueChanged=function(){autoSaveEnabled=autoSaveCheckbox.getValue()},autoSaveLayout.add(autoSaveCheckbox),autoSaveLayout.add(new ui.Label("Auto-save before import")),autoSaveLayout.setSpaceBetween(8),settingsLayout.add(autoSaveLayout);var gradientsLayout=new ui.HLayout,importGradientsCheckbox=new ui.Checkbox(importGradientsEnabled);importGradientsCheckbox.onValueChanged=function(){importGradientsEnabled=importGradientsCheckbox.getValue()},gradientsLayout.add(importGradientsCheckbox),gradientsLayout.add(new ui.Label("Import gradients")),gradientsLayout.setSpaceBetween(6),settingsLayout.add(gradientsLayout);var liveTextLayout=new ui.HLayout,importLiveTextCheckbox=new ui.Checkbox(importLiveTextEnabled);importLiveTextCheckbox.onValueChanged=function(){importLiveTextEnabled=importLiveTextCheckbox.getValue()},liveTextLayout.add(importLiveTextCheckbox),liveTextLayout.add(new ui.Label("Import live text")),liveTextLayout.setSpaceBetween(8),settingsLayout.add(liveTextLayout);var imageryLayout=new ui.HLayout,importImageryCheckbox=new ui.Checkbox(importImageryEnabled);importImageryCheckbox.onValueChanged=function(){importImageryEnabled=importImageryCheckbox.getValue()},imageryLayout.add(importImageryCheckbox),imageryLayout.add(new ui.Label("Import imagery")),imageryLayout.setSpaceBetween(8),settingsLayout.add(imageryLayout);var effectsLayout=new ui.HLayout,importEffectsCheckbox=new ui.Checkbox(importEffectsEnabled);importEffectsCheckbox.onValueChanged=function(){importEffectsEnabled=importEffectsCheckbox.getValue()},effectsLayout.add(importEffectsCheckbox),effectsLayout.add(new ui.Label("Import effects (blur, drop shadow)")),effectsLayout.setSpaceBetween(8),settingsLayout.add(effectsLayout);var qualityLayout=new ui.HLayout;qualityLayout.add(new ui.Label("Image quality"));var filterQualityDropdown=new ui.DropDown;filterQualityDropdown.addEntry("None (Fastest)"),filterQualityDropdown.addEntry("Bilinear"),filterQualityDropdown.addEntry("Mipmaps (Use For Scaling Down)"),filterQualityDropdown.addEntry("Bicubic (Use For Scaling Up)"),filterQualityDropdown.setValue(imageFilterQuality),filterQualityDropdown.onValueChanged=function(){imageFilterQuality=filterQualityDropdown.getValue()},qualityLayout.addStretch(),qualityLayout.add(filterQualityDropdown),settingsLayout.add(qualityLayout),settingsLayout.addSpacing(16),rectangleConversionLabel=new ui.Label("Rectangle conversion settings"),rectangleConversionLabel.setTextColor("#969696"),settingsLayout.add(rectangleConversionLabel);var radiusLayout=new ui.HLayout;radiusLayout.add(new ui.Label("Default radius"));var cornerRadiusInput=new ui.LineEdit;cornerRadiusInput.setText(defaultRadius),cornerRadiusInput.setPlaceholder("15"),cornerRadiusInput.setMaximumWidth(60),cornerRadiusInput.onTextChanged=function(){defaultRadius=cornerRadiusInput.getText()},radiusLayout.addStretch(),radiusLayout.add(cornerRadiusInput),settingsLayout.add(radiusLayout);var keepLayout=new ui.HLayout,keepOriginalCheckbox=new ui.Checkbox(keepOriginalEnabled);keepOriginalEnabled?keepOriginalCheckbox.setValue(!0):keepOriginalCheckbox.setValue(!1),keepOriginalCheckbox.onValueChanged=function(){keepOriginalEnabled=keepOriginalCheckbox.getValue()},keepLayout.add(keepOriginalCheckbox),keepLayout.add(new ui.Label("Keep original shapes")),keepLayout.setSpaceBetween(8),settingsLayout.add(keepLayout),settingsLayout.addSpacing(15);var buttonLayout=new ui.HLayout;buttonLayout.setSpaceBetween(10);var applyButton=new ui.Button("Apply");applyButton.setMinimumHeight(24),applyButton.onClick=function(){autoSaveEnabled=autoSaveCheckbox.getValue(),keepOriginalEnabled=keepOriginalCheckbox.getValue(),defaultRadius=cornerRadiusInput.getText(),importGradientsEnabled=importGradientsCheckbox.getValue(),importLiveTextEnabled=importLiveTextCheckbox.getValue(),importImageryEnabled=importImageryCheckbox.getValue(),importEffectsEnabled=importEffectsCheckbox.getValue(),imageFilterQuality=filterQualityDropdown.getValue(),console.info("Settings applied")};var closeButton=new ui.Button("Close");closeButton.setMinimumHeight(24),closeButton.onClick=function(){settingsWindow.close(),settingsWindow=null},buttonLayout.add(applyButton),buttonLayout.add(closeButton),settingsLayout.add(buttonLayout),settingsLayout.addSpacing(32);var settingsLogo=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_logo.png");settingsLogo.setImageSize(106,35),settingsLogo.setDrawStroke(!1),settingsLogo.setBackgroundColor(ui.getThemeColor("Base")),settingsLogo.setTransparentForMouseEvents(!0),settingsLayout.add(settingsLogo),settingsLayout.addSpacing(10);var sloganLabel=new ui.Label("Fire SVGs from Figma into Cavalry üèπ");sloganLabel.setTextColor("#bebebe"),sloganLabel.setAlignment(1),settingsLayout.add(sloganLabel);var versionLabel=new ui.Label("Version 1.5.2");versionLabel.setAlignment(1),versionLabel.setTextColor("#bebebe"),settingsLayout.add(versionLabel),settingsLayout.addSpacing(16);var finePrint1=new ui.Label("Any q's or bugs?");finePrint1.setTextColor("#969696"),finePrint1.setAlignment(1),settingsLayout.add(finePrint1);var finePrint2=new ui.Label("Raise an issue on GitHub.");finePrint2.setTextColor("#969696"),finePrint2.setAlignment(1),settingsLayout.add(finePrint2);var finePrintCredit=new ui.Label("Made by the Canva Creative Team");finePrintCredit.setAlignment(1),finePrintCredit.setTextColor("#969696"),settingsLayout.add(finePrintCredit);var openGitHubButton=new ui.Button("Open GitHub Repo");openGitHubButton.setMinimumHeight(24),openGitHubButton.onClick=function(){api.openURL("https://github.com/phillip-motion/quiver")},settingsLayout.add(openGitHubButton);var openCreativeTeamButton=new ui.Button("canvacreative.team/motion");openCreativeTeamButton.setMinimumHeight(24),openCreativeTeamButton.onClick=function(){api.openURL("https://canvacreative.team/motion")},settingsLayout.add(openCreativeTeamButton),settingsLayout.addSpacing(5),settingsLayout.addStretch(),settingsWindow.setLayout(settingsLayout),settingsWindow.move(50,50),settingsWindow.show()}renamerButton.setImageSize(22,22),renamerButton.setSize(34,34),renamerButton.setToolTip("Rename"),renamerButton.onClick=function(){try{renameSelectedLayers()}catch(e){console.error("Rename error: "+e.message)}},settingsButton.onClick=function(){createSettingsWindow()};var mainLayout=new ui.VLayout;mainLayout.setSpaceBetween(0),mainLayout.setMargins(0,0,0,0);var headerLayout=new ui.HLayout,newVersionAvailableLayout=new ui.HLayout;newVersionAvailableLayout.setMargins(6,0,3,6);var newVersionAvailableLabel=new ui.Label("New version available");newVersionAvailableLabel.setMinimumWidth(120),newVersionAvailableLabel.setContentsMargins(0,7,0,0),newVersionAvailableLabel.setTextColor("#ffffff"),newVersionAvailableLayout.add(newVersionAvailableLabel);var newVersionAvailableButton=new ui.Button("Update");newVersionAvailableButton.setMinimumHeight(24),newVersionAvailableButton.onClick=function(){api.openURL("https://github.com/phillip-motion/quiver/releases/latest")},newVersionAvailableLayout.addStretch(),newVersionAvailableLayout.add(newVersionAvailableButton);var newVersionAvailable=new ui.Container;if(newVersionAvailable.setBackgroundColor("#4a53fa"),newVersionAvailable.setLayout(newVersionAvailableLayout),api.hasPreferenceObject(scriptName+"_update_check")){var updatePrefs=api.getPreferenceObject(scriptName+"_update_check");updatePrefs.latestVersion&&compareVersions(updatePrefs.latestVersion,"1.5.2")>0&&mainLayout.add(newVersionAvailable)}var mainButtonsContainer=new ui.Container;mainButtonsContainer.setBackgroundColor(ui.getThemeColor("AlternateBase"));var mainButtons=new ui.HLayout;mainButtons.setSpaceBetween(6),mainButtons.setMargins(6,6,6,6);var logo=new ui.ImageButton(ui.scriptLocation+"/quiver_assets/quiver_icon.png");logo.setImageSize(28,29),logo.setBackgroundColor(ui.getThemeColor("AlternateBase")),logo.setDrawStroke(!1),logo.setTransparentForMouseEvents(!0),logo.setSize(28,29),mainButtons.add(logo),mainButtons.add(pasteButton),mainButtons.add(importFileButton),mainButtonsContainer.setLayout(mainButtons),mainLayout.add(mainButtonsContainer);var toolButtonsContainer=new ui.Container,toolsVLayout=new ui.VLayout;toolsVLayout.setSpaceBetween(2),toolsVLayout.setMargins(6,6,6,6);var toolButtonsLayout=new ui.HLayout;toolButtonsLayout.add(convertRectButton),toolButtonsLayout.add(dynamicAlignButton),toolButtonsLayout.add(flattenShapeButton),toolButtonsLayout.addStretch(),toolButtonsLayout.add(settingsButton);var renameLayout=new ui.HLayout;
// quiver_function_flattenShape.js
function flattenShape(){try{var sel=api.getSelection();if(!sel||0===sel.length)return void console.error("Please select shape(s) to flatten");for(var shapeTypes=["rectangleShape","ellipseShape","starShape","polygonShape","customShape","editable","editableShape","textShape","pathShape"],alternateTypes=["rectangle","ellipse","star","polygon","path","text"],validShapes=[],i=0;i<sel.length;i++)try{var type=api.getType(sel[i]);-1===shapeTypes.indexOf(type)&&-1===alternateTypes.indexOf(type)||validShapes.push(sel[i])}catch(e){}0===validShapes.length&&(validShapes=sel);var firstItemName="";try{firstItemName=api.getNiceName(validShapes[0])||""}catch(e){}var groupId,baseName=firstItemName||"Shape",customShapeName=baseName+" Flattened",groupName=baseName+" Group",customShapeId=null;try{customShapeId=api.create("customShape",customShapeName)}catch(e){var errorMsg=e&&e.message?e.message:"Failed to create custom shape";return void console.error(errorMsg)}try{groupId=api.create("group",groupName),api.parent(groupId,customShapeId);for(i=0;i<validShapes.length;i++)api.parent(validShapes[i],groupId)}catch(e){errorMsg=e&&e.message?e.message:"Failed to create/organize group";return void console.error(errorMsg)}try{api.connect(groupId,"id",customShapeId,"inputShape")}catch(e){errorMsg=e&&e.message?e.message:"Failed to connect group to custom shape";return void console.error(errorMsg)}try{api.set(groupId,{hidden:!0})}catch(e){}try{var deformerId=null,deformerName="Flatten Shape Layers ["+customShapeName+"]";try{deformerId=api.create("flattenShapeLayers",deformerName)}catch(eCreate){}if(!deformerId)return void console.error("Error: Could not create Flatten Shape Layers deformer");try{api.connect(deformerId,"id",customShapeId,"deformers")}catch(eConnect){return void console.error("Error connecting deformer to custom shape")}try{api.parent(deformerId,customShapeId)}catch(eParent){}}catch(e){errorMsg=e&&e.message?e.message:"Failed to add deformer";return void console.error(errorMsg)}try{api.select([customShapeId])}catch(e){}console.info("Flattened "+validShapes.length+" shape(s) into: "+customShapeName)}catch(e){console.error("Error: "+e.message)}}
// quiver_function_convertToRectangle.js
function _copyBasicStyles(fromId,toId){try{var fillOn=!1;try{fillOn=api.hasFill(fromId)}catch(e){}if(fillOn){try{api.setFill(toId,!0)}catch(eF1){}var fs={};try{var col=api.get(fromId,"material.materialColor");col&&(fs["material.materialColor"]=col)}catch(eC){}try{var al=api.get(fromId,"material.alpha");"number"==typeof al&&(fs["material.alpha"]=al)}catch(eA){}if(Object.keys(fs).length)try{api.set(toId,fs)}catch(eFS){}}else try{api.setFill(toId,!1)}catch(eF0){}var strokeOn=!1;try{strokeOn=api.hasStroke(fromId)}catch(eS){}if(strokeOn){try{api.setStroke(toId,!0)}catch(eS1){}var ss={};try{var scol=api.get(fromId,"stroke.strokeColor");scol&&(ss["stroke.strokeColor"]=scol)}catch(eSC){}try{var sw=api.get(fromId,"stroke.width");"number"==typeof sw&&(ss["stroke.width"]=sw)}catch(eSW){}try{var sa=api.get(fromId,"stroke.alpha");"number"==typeof sa&&(ss["stroke.alpha"]=sa)}catch(eSA){}try{var salign=api.get(fromId,"stroke.align");if(null!=salign){var okAlign=!1;try{api.set(toId,{"stroke.align":salign}),okAlign=!0}catch(eSetAlign){okAlign=!1}if(!okAlign){var enumVal=0,sval=(""+salign).toLowerCase();"inner"===sval?enumVal=1:"outer"===sval&&(enumVal=2);try{api.set(toId,{"stroke.align":enumVal})}catch(eSetAlign2){}}}}catch(eGA){}try{var capStyle=api.get(fromId,"stroke.capStyle");if(null!=capStyle)try{api.set(toId,{"stroke.capStyle":capStyle})}catch(eSetCap){}}catch(eGCap){}try{var joinStyle=api.get(fromId,"stroke.joinStyle");if(null!=joinStyle)try{api.set(toId,{"stroke.joinStyle":joinStyle})}catch(eSetJoin){}}catch(eGJoin){}try{var dp=api.get(fromId,"stroke.dashPattern");if(dp)try{api.set(toId,{"stroke.dashPattern":dp})}catch(eDPs){}var dm=api.get(fromId,"stroke.dashPatternMode");if(null!=dm)try{api.set(toId,{"stroke.dashPatternMode":dm})}catch(eDMs){}var dof=api.get(fromId,"stroke.dashOffset");if("number"==typeof dof)try{api.set(toId,{"stroke.dashOffset":dof})}catch(eDOf){}}catch(eDash){}if(Object.keys(ss).length)try{api.set(toId,ss)}catch(eSS){}}else try{api.setStroke(toId,!1)}catch(eS0){}}catch(eAll){}}function convertSelectionToRect(keepOriginalHidden){try{var selection=api.getSelection();if(!selection||0===selection.length)return void console.error("Select at least one layer");for(var defVal=parseFloat(defaultRadius),converted=0,i=0;i<selection.length;i++){var layerId=selection[i];if(api.layerExists(layerId)){var bbox=null;try{bbox=api.getBoundingBox(layerId,!0)}catch(eBB){bbox=null}if(bbox&&bbox.width&&bbox.height){var name=null;try{name=api.getNiceName(layerId)}catch(eNm){name=null}name||(name="Converted Shape");var isCircle=Math.abs((bbox.width||0)-(bbox.height||0))<.5&&!isNaN(defVal)&&defVal>=bbox.width/2-.5,prim=isCircle?"ellipse":"rectangle",newId=null;try{newId=api.primitive(prim,name+(isCircle?" (Circle)":" (Rect)"))}catch(eCr){newId=null}if(newId){try{if(isCircle)api.set(newId,{"generator.radius":[bbox.width/2,bbox.height/2],"position.x":bbox.centre.x,"position.y":bbox.centre.y});else if(api.set(newId,{"generator.dimensions":[bbox.width,bbox.height],"position.x":bbox.centre.x,"position.y":bbox.centre.y}),!isNaN(defVal)&&defVal>0)try{api.set(newId,{"generator.cornerRadius":defVal})}catch(eCR){}}catch(eSet){}_copyBasicStyles(layerId,newId);try{var parentId=api.getParent(layerId);parentId&&api.parent(newId,parentId);var rot=api.get(layerId,"rotation");"number"==typeof rot&&api.set(newId,{rotation:rot});var sx=api.get(layerId,"scale.x"),sy=api.get(layerId,"scale.y"),scaleSet={};"number"==typeof sx&&(scaleSet["scale.x"]=sx),"number"==typeof sy&&(scaleSet["scale.y"]=sy),Object.keys(scaleSet).length&&api.set(newId,scaleSet)}catch(eTr){}try{keepOriginalHidden?api.set(layerId,{hidden:!0}):api.deleteLayer(layerId)}catch(eDel){}converted++}}}}console.info(converted>0?"Converted "+converted+" layer(s)":"No valid layers")}catch(e){var errorMsg=e&&e.message?e.message:"An error occurred";"undefined"!==errorMsg&&"null"!==errorMsg&&console.error("Error: "+errorMsg)}}
// quiver_function_dynamicAlign.js
function applyDynamicAlignToLayer(layerId){try{if(!api.layerExists(layerId))return!1;var bbox=null;try{bbox=api.getBoundingBox(layerId,!0)}catch(e){bbox=null}if(!bbox||!bbox.width||!bbox.height)return!1;var sx=1,sy=1;try{sx=api.get(layerId,"scale.x"),sy=api.get(layerId,"scale.y")}catch(eS){sx=1,sy=1}isFinite(sx)&&0!==sx||(sx=1),isFinite(sy)&&0!==sy||(sy=1);var originalWidth=bbox.width/sx,originalHeight=bbox.height/sy,alignId=null;try{alignId=api.create("align","Dynamic Align")}catch(eA){alignId=null}if(!alignId)return!1;try{api.connect(alignId,"id",layerId,"deformers")}catch(eConDef){}var jsId=null;try{jsId=api.create("javaScript","Scale Aware Pivot")}catch(eJ){jsId=null}if(!jsId)return!1;try{api.addDynamic(jsId,"array","double")}catch(eD1){}try{api.addDynamic(jsId,"array","double")}catch(eD2){}var expr="// Original unscaled dimensions\nvar originalWidth = "+originalWidth+";\nvar originalHeight = "+originalHeight+";\n\n// Half dimensions\nvar halfWidth = (originalWidth / 2);\nvar halfHeight = (originalHeight / 2);\n\n// Inputs\nvar pivotX = halfWidth * alignX;\nvar pivotY = halfHeight * alignY;\n\n[pivotX, pivotY]";try{api.set(jsId,{expression:expr})}catch(eExpr){}try{api.renameAttribute(jsId,"array.1","alignX")}catch(eR1){}try{api.renameAttribute(jsId,"array.2","alignY")}catch(eR2){}try{api.connect(alignId,"x",jsId,"array.1")}catch(eAx){}try{api.connect(alignId,"y",jsId,"array.2")}catch(eAy){}try{api.connect(jsId,"id",layerId,"pivot")}catch(ePiv){}try{api.parent(alignId,layerId)}catch(ePA){}try{api.parent(jsId,layerId)}catch(ePJ){}return!0}catch(eAll){return!1}}
// quiver_function_renameLayers.js
function renameSelectedLayers(){try{var sel=api.getSelection();if(!sel||0===sel.length)return void console.error("Please select layer(s) to rename");var newName=renamerInput.getText().trim();if(!newName)return void console.error("Please enter a name in the rename field");var renamed=0;if(1===sel.length)try{api.rename(sel[0],newName),renamed=1}catch(e){}else for(var i=0;i<sel.length;i++)try{var numberedName=newName+" "+(i+1);api.rename(sel[i],numberedName),renamed++}catch(e){}renamed>0?console.info("Renamed "+renamed+" layer(s)"):console.error("Failed to rename layers")}catch(e){console.error("Error: "+e.message)}}
// quiver_utiltiies_sharedFunctions.js
function clamp01(n){return Math.max(0,Math.min(1,n))}function parseOpacityValue(value){if(null==value||""===value)return null;var v=(""+value).trim();if(v.endsWith("%")){var num=parseFloat(v.slice(0,-1));return isNaN(num)?null:clamp01(num/100)}var n=parseFloat(v);return isNaN(n)?null:clamp01(n)}function parseColor(colorString){if(!colorString||"none"===colorString)return null;if("#"===colorString[0])return colorString;var named={white:"#FFFFFF",black:"#000000",red:"#FF0000",green:"#008000",blue:"#0000FF",yellow:"#FFFF00",cyan:"#00FFFF",magenta:"#FF00FF",gray:"#808080",grey:"#808080"},lower=(colorString+"").toLowerCase();if(named[lower])return named[lower];if(0===lower.indexOf("rgb(")){var m=lower.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(m)return"#"+parseInt(m[1]).toString(16).padStart(2,"0")+parseInt(m[2]).toString(16).padStart(2,"0")+parseInt(m[3]).toString(16).padStart(2,"0")}if(0===lower.indexOf("rgba(")){var mr=lower.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);if(mr)return"#"+parseInt(mr[1]).toString(16).padStart(2,"0")+parseInt(mr[2]).toString(16).padStart(2,"0")+parseInt(mr[3]).toString(16).padStart(2,"0")}return colorString}function normalizeDashArrayToCsv(val){try{if(null==val)return null;var s=(""+val).trim();if(!s||"none"===s.toLowerCase()||"0"===s)return null;for(var parts=(s=s.replace(/,/g," ")).split(/\s+/).filter(function(t){return""!==t}),nums=[],i=0;i<parts.length;i++){var n=parseFloat(parts[i]);!isNaN(n)&&isFinite(n)&&nums.push(Math.max(0,n))}return 0===nums.length?null:nums.join(", ")}catch(e){return null}}function extractAttribute(tag,name){if(!tag||!name)return null;var match=new RegExp("(?:^|\\s)"+name+'\\s*=\\s*"([^"]*)"').exec(tag);return match||(match=new RegExp("(?:^|\\s)"+name+"\\s*=\\s*'([^']*)'").exec(tag))?match[1]:null}function extractStyleProperty(styleString,propertyName){if(!styleString||!propertyName)return null;for(var parts=styleString.split(";"),target=(""+propertyName).trim().toLowerCase(),i=0;i<parts.length;i++){var seg=parts[i];if(seg){var kv=seg.split(":");if(!(kv.length<2))if(kv[0].trim().toLowerCase()===target)return kv.slice(1).join(":").trim()}}return null}function mergeInlineStyleIntoAttrs(openingTag){var styleAttr=extractAttribute(openingTag,"style"),merged={};if(!styleAttr)return merged;for(var parts=styleAttr.split(";"),i=0;i<parts.length;i++){var seg=parts[i];if(seg){var kv=seg.split(":");if(!(kv.length<2)){var key=kv[0].trim(),val=kv.slice(1).join(":").trim();merged[key]=val}}}return merged}function decodeEntitiesForName(str){if(!str)return str;var out=str;return out=(out=(out=out.replace(/&#x([0-9a-fA-F]+);/g,function(_,hex){try{return String.fromCodePoint(parseInt(hex,16))}catch(e){return _}})).replace(/((?:&#\d+;)+)/g,function(group){for(var m,nums=[],rx=/&#(\d+);/g;null!==(m=rx.exec(group));)nums.push(parseInt(m[1],10));if(0===nums.length)return group;try{var perc=nums.map(function(n){var h=n.toString(16).toUpperCase();return h.length<2&&(h="0"+h),"%"+h}).join("");return decodeURIComponent(perc)}catch(e){return nums.map(function(n){try{return String.fromCodePoint(n)}catch(e2){return""}}).join("")}})).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'")}function extractUrlRefId(value){if(!value)return null;var m=/url\(#([^\)]+)\)/.exec(value);return m?m[1]:null}renameLayout.add(renamerInput),renameLayout.add(renamerButton),toolsVLayout.add(renameLayout),toolsVLayout.add(toolButtonsLayout),toolButtonsContainer.setLayout(toolsVLayout),mainLayout.add(toolButtonsContainer),mainLayout.addStretch(),ui.add(mainLayout),ui.setMargins(0,0,0,0),ui.setMinimumWidth(150),ui.onClose=function(){try{if(void 0!==Quiver&&"function"==typeof Quiver.cleanup&&Quiver.cleanup(),settingsWindow){try{settingsWindow.close()}catch(e){}settingsWindow=null}}catch(e){}},ui.show();var __svgGradientMap={},__svgGradientCache={},__createdPathLayers=[],__svgFilterMap={},__filterNodesCache={},__groupDirectChildren={},__imageImportCache={},__svgPatternMap={},__patternImageShaderCache={},__lastPatternOrImageName="img",__imageNamingContext={},__imageCounter=0,__groupCounter=0;function setPatternContext(map){__svgPatternMap=map||{},__patternImageShaderCache={}}function _hasAttr(id,attr){try{if(api.hasAttribute)return!!api.hasAttribute(id,attr)}catch(e){}try{api.get(id,attr);return!0}catch(e2){return!1}}function _sanitizeFileComponent(name){try{var s=(null==name?"":""+name).trim();return(s=(s=(s=decodeEntitiesForName(s)).replace(/[^A-Za-z0-9._-]+/g,"_")).replace(/^_+|_+$/g,""))||(s="img"),s.length>40&&(s=s.slice(0,40)),s}catch(e){return"img"}}function _setFirstSupported(id,candidates,value){for(var i=0;i<candidates.length;i++){var a=candidates[i];if(_hasAttr(id,a))try{var obj={};return obj[a]=value,api.set(id,obj),a}catch(eSet){}}return null}function connectShaderToShape(shaderId,shapeId){try{api.setFill(shapeId,!0)}catch(e){}try{api.set(shapeId,{"material.materialColor.a":0})}catch(eA){}try{api.connect(shaderId,"id",shapeId,"material.colorShaders");try{api.set(shaderId,{hidden:!1})}catch(eVis){}try{var gradientData=null;if(__svgGradientMap&&__svgGradientCache){for(var gid in __svgGradientCache)if(__svgGradientCache[gid]===shaderId){gradientData=__svgGradientMap[gid];break}if(gradientData)try{gradientData._absoluteCenterX}catch(e0){}else;}if(gradientData&&void 0!==gradientData._absoluteCenterX&&void 0!==gradientData._absoluteCenterY){var absX=parseFloat(gradientData._absoluteCenterX),absY=parseFloat(gradientData._absoluteCenterY);if(isNaN(absX)||isNaN(absY))return;var bbox=null;try{bbox=api.getBoundingBox(shapeId)}catch(eBbox1){try{bbox=api.getBoundingBox(shapeId,!0)}catch(eBbox2){}}if(bbox){var shapeCenterX,shapeCenterY;if(bbox.centre)shapeCenterX=bbox.centre.x,shapeCenterY=bbox.centre.y;else{if(void 0===bbox.x||void 0===bbox.y||void 0===bbox.width||void 0===bbox.height)return;shapeCenterX=bbox.x+bbox.width/2,shapeCenterY=bbox.y+bbox.height/2}var gradientSvgX=absX,gradientSvgY=absY,shapePos=null;try{shapePos=api.get(shapeId,"position")}catch(ePos){}if(shapePos){var relativeOffsetX=gradientSvgX-shapeCenterX,relativeOffsetY=-(gradientSvgY-shapeCenterY);try{if(isNaN(relativeOffsetX)||isNaN(relativeOffsetY))return;api.set(shaderId,{"generator.offset.x":relativeOffsetX,"generator.offset.y":relativeOffsetY})}catch(eOffset){}}}}}catch(eCalcOffset){}try{var currentParent=null;try{currentParent=api.getParent(shaderId)}catch(ePar){currentParent=null}currentParent||api.parent(shaderId,shapeId)}catch(ePar2){}return!0}catch(e1){}return!1}function connectShaderToStroke(shaderId,shapeId){try{api.setStroke(shapeId,!0)}catch(e){}try{api.set(shapeId,{"stroke.strokeColor.a":0})}catch(eA){}try{api.connect(shaderId,"id",shapeId,"stroke.colorShaders");try{var currentParent=null;try{currentParent=api.getParent(shaderId)}catch(ePar){currentParent=null}currentParent||api.parent(shaderId,shapeId)}catch(ePar2){}return!0}catch(e1){}return!1}
// quiver_utilities_blendmode.js
var BLEND_MODE_MAP=[["normal",0],["multiply",24],["screen",14],["overlay",15],["darken",16],["lighten",17],["color-dodge",18],["color-burn",19],["hard-light",20],["soft-light",21],["difference",22],["exclusion",23],["hue",25],["saturation",26],["color",27],["luminosity",28],["plus-lighter",12],["plus",12],["alpha-add",30],["plus-darker",32]];function svgBlendModeToCavalryEnum(svgMode){if(!svgMode)return null;for(var normalized=(""+svgMode).toLowerCase().trim(),i=0;i<BLEND_MODE_MAP.length;i++)if(BLEND_MODE_MAP[i][0]===normalized)return BLEND_MODE_MAP[i][1];return null}function applyBlendMode(layerId,attrs){if(layerId&&attrs)try{var blendMode=attrs["mix-blend-mode"]||attrs.style&&extractStyleProperty(attrs.style,"mix-blend-mode");if(!blendMode||"normal"===blendMode)return;var enumValue=svgBlendModeToCavalryEnum(blendMode);if(null!==enumValue&&0!==enumValue)try{api.set(layerId,{blendMode:enumValue})}catch(eSet){}}catch(e){}}
// quiver_utilities_gradient.js
function setGradientContext(map){__svgGradientMap=map||{},__svgGradientCache={}}function getGradientShader(gradientId){if(!gradientId)return null;if(__svgGradientCache[gradientId])return __svgGradientCache[gradientId];var data=__svgGradientMap[gradientId];if(!data)return null;try{void 0!==data._absoluteCenterX||data._absoluteCenterY}catch(e){}var sh=createGradientShader(data);return sh&&(__svgGradientCache[gradientId]=sh),sh}function _gradGetAttr(element,name){var match=new RegExp(name+"\\s*=\\s*[\"']([^\"']*)[\"']").exec(element);return match?match[1]:null}function colorWithOpacity(hexColor,opacity){if(!hexColor||"#"!==hexColor[0])return hexColor;var h=hexColor.replace("#","");if(3===h.length?h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2]:8===h.length&&6!==(h=h.slice(2)).length&&(h=h.slice(0,6)),6!==h.length)return hexColor;var a=Math.max(0,Math.min(1,opacity));return"#"+Math.round(255*a).toString(16).padStart(2,"0").toUpperCase()+h.toUpperCase()}function parseGradientStops(gradientElement){for(var match,stops=[],stopRegex=/<stop[^>]*>/g;null!==(match=stopRegex.exec(gradientElement));){var stopElement=match[0],offset=_gradGetAttr(stopElement,"offset"),stopColor=_gradGetAttr(stopElement,"stop-color"),stopOpacity=_gradGetAttr(stopElement,"stop-opacity");if(!stopColor||!stopOpacity){var styleAttr=_gradGetAttr(stopElement,"style");styleAttr&&(stopColor||(stopColor=extractStyleProperty(styleAttr,"stop-color")),stopOpacity||(stopOpacity=extractStyleProperty(styleAttr,"stop-opacity")))}var offsetNum=0;offset&&(offsetNum=-1!==offset.indexOf("%")?parseFloat(offset)/100:parseFloat(offset),isNaN(offsetNum)&&(offsetNum=0));var opacity=stopOpacity?parseFloat(stopOpacity):1;isNaN(opacity)&&(opacity=1),stops.push({offset:Math.max(0,Math.min(1,offsetNum)),color:parseColor(stopColor),opacity:opacity})}return stops.sort(function(a,b){return a.offset-b.offset}),stops}function extractGradients(svgCode){for(var m,gradients=[],linearRegex=/<linearGradient[^>]*>[\s\S]*?<\/linearGradient>/g;null!==(m=linearRegex.exec(svgCode));){var el=m[0],id=_gradGetAttr(el,"id"),gradientUnits=_gradGetAttr(el,"gradientUnits")||"objectBoundingBox",x1=parseFloat(_gradGetAttr(el,"x1")||"0"),y1=parseFloat(_gradGetAttr(el,"y1")||"0"),x2=parseFloat(_gradGetAttr(el,"x2")||"1"),y2=parseFloat(_gradGetAttr(el,"y2")||"0"),transform=_gradGetAttr(el,"gradientTransform"),stops=parseGradientStops(el);if(stops.length>0){var grad={type:"linear",id:id||"linear_"+gradients.length,x1:x1,y1:y1,x2:x2,y2:y2,stops:stops,gradientUnits:gradientUnits};transform&&(grad.transform=transform),gradients.push(grad)}}for(var radialRegex=/<radialGradient[^>]*>[\s\S]*?<\/radialGradient>/g;null!==(m=radialRegex.exec(svgCode));){var el2=m[0],id2=_gradGetAttr(el2,"id"),defaultVal="userSpaceOnUse"===(gradientUnits=_gradGetAttr(el2,"gradientUnits")||"objectBoundingBox")?"0":"0.5",cx=parseFloat(_gradGetAttr(el2,"cx")||defaultVal),cy=parseFloat(_gradGetAttr(el2,"cy")||defaultVal),r=parseFloat(_gradGetAttr(el2,"r")||defaultVal),fx=_gradGetAttr(el2,"fx"),fy=_gradGetAttr(el2,"fy");fx=null!==fx?parseFloat(fx):cx,fy=null!==fy?parseFloat(fy):cy;var transform2=_gradGetAttr(el2,"gradientTransform"),stops2=parseGradientStops(el2);if(stops2.length>0){var grad2={type:"radial",id:id2||"radial_"+gradients.length,cx:cx,cy:cy,r:r,fx:fx,fy:fy,stops:stops2,gradientUnits:gradientUnits};transform2&&(grad2.transform=transform2),gradients.push(grad2)}}return gradients}function createGradientShader(gradientData){try{if(!importGradientsEnabled)return null;var shaderId=api.create("gradientShader","Gradient "+gradientData.id);if("radial"===gradientData.type)try{api.setGenerator(shaderId,"generator","radialGradientShader")}catch(e){}else try{api.setGenerator(shaderId,"generator","linearGradientShader")}catch(e){}if("radial"===gradientData.type){try{var radiusMode=1;"userSpaceOnUse"===gradientData.gradientUnits&&(radiusMode=0),api.set(shaderId,{"generator.radiusMode":radiusMode})}catch(eRM){}var calculatedRadius=null;if(void 0!==gradientData.r&&"userSpaceOnUse"===gradientData.gradientUnits)if(gradientData.transform)try{var decomposed=decomposeMatrix(parseTransformMatrixList(gradientData.transform)),avgScale=((scaleX=Math.abs(decomposed.scaleX))+(scaleY=Math.abs(decomposed.scaleY)))/2;calculatedRadius=gradientData.r*avgScale}catch(eT){calculatedRadius=gradientData.r}else calculatedRadius=gradientData.r;if("radial"===gradientData.type){try{void 0!==gradientData._absoluteCenterX||gradientData._absoluteCenterY}catch(e0){}try{var offsetX,offsetY;if("userSpaceOnUse"===gradientData.gradientUnits){if(offsetX=void 0!==gradientData.cx?parseFloat(gradientData.cx):0,offsetY=void 0!==gradientData.cy?parseFloat(gradientData.cy):0,gradientData.transform)try{decomposed=decomposeMatrix(parseTransformMatrixList(gradientData.transform));var translateX=parseFloat(decomposed.translateX)||0,translateY=parseFloat(decomposed.translateY)||0;offsetX+=translateX,offsetY+=translateY}catch(eT){}if(__svgGradientMap&&__svgGradientMap[gradientData.id]){var absX=parseFloat(offsetX),absY=parseFloat(offsetY);isNaN(absX)||isNaN(absY)||(__svgGradientMap[gradientData.id]._absoluteCenterX=absX,__svgGradientMap[gradientData.id]._absoluteCenterY=absY,__svgGradientMap[gradientData.id]._gradientUnits=gradientData.gradientUnits,gradientData._absoluteCenterX=absX,gradientData._absoluteCenterY=absY)}offsetX=0,offsetY=0}else offsetX=2*(gradientData.cx-.5),offsetY=2*(gradientData.cy-.5),offsetX=Math.max(-2,Math.min(2,offsetX)),offsetY=Math.max(-2,Math.min(2,offsetY));try{api.set(shaderId,{"generator.offset.x":offsetX,"generator.offset.y":offsetY});try{api.get(shaderId,"generator.offset.x"),api.get(shaderId,"generator.offset.y")}catch(eGet){}}catch(eXY){try{api.set(shaderId,{"generator.offset":[offsetX,offsetY]})}catch(eArr){}}try{var currentRadius=api.get(shaderId,"generator.radius");api.set(shaderId,{"generator.radius":currentRadius})}catch(eUpdate){}}catch(eOff){}}if(void 0!==gradientData.r)try{if("userSpaceOnUse"===gradientData.gradientUnits){var radius=calculatedRadius||gradientData.r;try{api.set(shaderId,{"generator.radius":radius})}catch(eRad){}try{api.set(shaderId,{"generator.scale.x":100,"generator.scale.y":100})}catch(eResetScale){}if(gradientData.transform)try{decomposed=decomposeMatrix(parseTransformMatrixList(gradientData.transform));var scaleX=Math.abs(decomposed.scaleX),scaleY=Math.abs(decomposed.scaleY);Math.abs(scaleX-scaleY)}catch(eT){}}else{var scale=gradientData.r/.5;if(scale>5&&(scale=2),scale=parseFloat(scale.toFixed(2)),Math.abs(scale-1)>.01)try{api.set(shaderId,{"generator.scale.x":scale,"generator.scale.y":scale})}catch(eXY){try{api.set(shaderId,{"generator.scale":[scale,scale]})}catch(eArr){try{api.set(shaderId,{"generator.scale":scale})}catch(eSingle){}}}}}catch(eScale){}}var angle=0;if("linear"===gradientData.type){var dx=gradientData.x2-gradientData.x1,dy=gradientData.y2-gradientData.y1;angle=(180*Math.atan2(-dy,dx)/Math.PI%360+360)%360,api.set(shaderId,{"generator.rotation":angle})}if(gradientData.transform)try{decomposed=decomposeMatrix(parseTransformMatrixList(gradientData.transform));if(Math.abs(decomposed.rotationDeg)>1e-4){var cavalryRotation=-decomposed.rotationDeg;api.set(shaderId,{"generator.rotation":cavalryRotation})}if(Math.abs(decomposed.scaleX-1)>1e-4||Math.abs(decomposed.scaleY-1)>1e-4){scaleX=decomposed.scaleX,scaleY=decomposed.scaleY;if("userSpaceOnUse"===gradientData.gradientUnits&&"radial"===gradientData.type);else if("userSpaceOnUse"===gradientData.gradientUnits);else{(avgScale=(scaleX+scaleY)/2)>5&&(avgScale=5),avgScale=parseFloat(avgScale.toFixed(2));try{api.set(shaderId,{"generator.scale":[scaleX,scaleY]})}catch(eArr){try{api.set(shaderId,{"generator.scale.x":scaleX,"generator.scale.y":scaleY})}catch(eXY){try{api.set(shaderId,{"generator.scale":avgScale})}catch(eSingle){}}}}}}catch(e){}var colors=gradientData.stops.map(function(stop){return stop.color||"#000000"});1===colors.length&&colors.push(colors[0]),api.setGradientFromColors(shaderId,"generator.gradient",colors);for(var i=0;i<gradientData.stops.length;i++){var stop=gradientData.stops[i];try{var posAttr={};posAttr["generator.gradient."+i+".position"]=stop.offset,api.set(shaderId,posAttr)}catch(ePos){}try{var colAttr={};colAttr["generator.gradient."+i+".color"]=colorWithOpacity(stop.color,stop.opacity),api.set(shaderId,colAttr)}catch(eCol){}}return shaderId}catch(e){return null}}
// quiver_utilities_patterns.js
function extractPatterns(svgCode){var patterns={};try{for(var m,re=/<pattern[^>]*id=["']([^"']+)["'][^>]*>([\s\S]*?)<\/pattern>/g;null!==(m=re.exec(svgCode));){for(var pid=m[1],body=m[2]||"",open=m[0].slice(0,m[0].indexOf(">")+1),attrs={},keys=["x","y","width","height","patternUnits","patternContentUnits","patternTransform"],i=0;i<keys.length;i++){var kk=keys[i],vv=extractAttribute(open,kk);null!==vv&&(attrs[kk]=vv)}var im=/<image[^>]*>/i.exec(body),image=null;if(im){var imgOpen=im[0],href=extractAttribute(imgOpen,"href")||extractAttribute(imgOpen,"xlink:href"),ix=extractAttribute(imgOpen,"x"),iy=extractAttribute(imgOpen,"y"),iw=extractAttribute(imgOpen,"width"),ih=extractAttribute(imgOpen,"height");image={href:href||"",x:ix||"0",y:iy||"0",width:iw||attrs.width||"0",height:ih||attrs.height||"0"}}if(!image){var useMatch=/<use[^>]*>/gi.exec(body);if(useMatch){var useOpen=useMatch[0],hrefUse=extractAttribute(useOpen,"href")||extractAttribute(useOpen,"xlink:href");if(hrefUse&&"#"===hrefUse.charAt(0)){var refId=hrefUse.slice(1);try{var esc=refId.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),mImg=new RegExp("<image[^>]*id=[\"']"+esc+"[\"'][^>]*>","i").exec(svgCode);if(mImg){var imgOpen2=mImg[0],href2=extractAttribute(imgOpen2,"href")||extractAttribute(imgOpen2,"xlink:href"),iw2=extractAttribute(imgOpen2,"width"),ih2=extractAttribute(imgOpen2,"height");image={href:href2||"",x:"0",y:"0",width:iw2||attrs.width||"0",height:ih2||attrs.height||"0"}}}catch(eFind){}}}}patterns[pid]={attrs:attrs,image:image}}}catch(e){}return patterns}
// quiver_utilities_images.js
var __quiverAssetGroupId=null;// Cache for the Quiver asset group in Assets Window
function _ensureQuiverAssetGroup(){try{
// Check if we already have the Quiver asset group
if(__quiverAssetGroupId&&api.layerExists&&api.layerExists(__quiverAssetGroupId))return __quiverAssetGroupId;
// Try to find existing Quiver asset group by checking all assets
var assetLayers=[];try{assetLayers=api.getAssetWindowLayers&&api.getAssetWindowLayers(!1)||[]}catch(e){}for(var i=0;i<assetLayers.length;i++){var assetId=assetLayers[i],assetName="";try{assetName=api.getNiceName(assetId)||""}catch(e){}if("Quiver"===assetName)return __quiverAssetGroupId=assetId}try{return api.createAssetGroup?__quiverAssetGroupId=api.createAssetGroup("Quiver"):null}catch(eCreate){return null}}catch(e){
// Error ensuring Quiver asset group
return null}}function _ensureAssetsQuiverFolder(){try{if(__imageImportCache.__quiverDir)return __imageImportCache.__quiverDir;var assetsPath=null;try{assetsPath=api.getAssetPath&&api.getAssetPath()||null}catch(eAP){assetsPath=null}if(assetsPath){var quiverInAssets=assetsPath+"/Quiver",finalAssets=assetsPath,folderExists=!1;try{folderExists=api.filePathExists&&api.filePathExists(quiverInAssets)}catch(e){}if(folderExists)finalAssets=quiverInAssets;else{var folderCreated=!1;try{api.ensureDirectory?(api.ensureDirectory(quiverInAssets,!1,!0),finalAssets=quiverInAssets,folderCreated=!0):api.makeFolder?(api.makeFolder(quiverInAssets),finalAssets=quiverInAssets,folderCreated=!0):api.createDirectory&&(api.createDirectory(quiverInAssets),finalAssets=quiverInAssets,folderCreated=!0)}catch(eMkFA){-1!==(eMkFA+"").indexOf("already exists")&&(finalAssets=quiverInAssets)}}if(!folderCreated&&api.runProcess)try{api.getPlatform&&"Windows"===api.getPlatform()?api.runProcess("cmd",["/c","mkdir",quiverInAssets.replace(/\//g,"\\")]):api.runProcess("mkdir",["-p",quiverInAssets]),finalAssets=quiverInAssets,folderCreated=!0}catch(eCmd){
// Could not create Quiver folder with system command
}return __imageImportCache.__quiverDir=finalAssets,__imageImportCache.__quiverDir}var projPath=null;try{projPath=api.getProjectFilePath&&api.getProjectFilePath()||projPath}catch(eProj){}try{projPath=projPath||api.getProjectPath&&api.getProjectPath()}catch(eProj2){}try{projPath=projPath||api.projectPath&&api.projectPath()}catch(eProj3){}try{projPath=projPath||api.getProjectDirectory&&api.getProjectDirectory()}catch(eProj4){}try{projPath=projPath||api.projectDirectory&&api.projectDirectory()}catch(eProj5){}var baseDir=null;if(projPath&&-1!==(projPath+"").indexOf("/")){var pstr=projPath+"";baseDir=/\.cv$/i.test(pstr)?pstr.substring(0,pstr.lastIndexOf("/")):pstr}if(!baseDir)try{baseDir=ui.selectDirectory&&ui.selectDirectory("Select your Cavalry Project folder (to create Assets/Quiver)")}catch(eSel){baseDir=null}if(!baseDir)return null;var assetsDir=baseDir+"/Assets",quiverDir=assetsDir+"/Quiver",finalDir=null;try{api.ensureDirectory?(api.ensureDirectory(assetsDir),finalDir=assetsDir):api.makeFolder?(api.makeFolder(assetsDir),finalDir=assetsDir):api.createDirectory&&(api.createDirectory(assetsDir),finalDir=assetsDir)}catch(eMkA){finalDir=null}
// Try Quiver subfolder; if it fails, keep using Assets root
folderExists=!1;try{folderExists=api.filePathExists&&api.filePathExists(quiverDir)}catch(e){}if(folderExists)finalDir=quiverDir;else{folderCreated=!1;try{api.ensureDirectory?(api.ensureDirectory(quiverDir,!1,!0),finalDir=quiverDir,folderCreated=!0):api.makeFolder?(api.makeFolder(quiverDir),finalDir=quiverDir,folderCreated=!0):api.createDirectory&&(api.createDirectory(quiverDir),finalDir=quiverDir,folderCreated=!0)}catch(eMkF){-1!==(eMkF+"").indexOf("already exists")&&(finalDir=quiverDir)}}if(!folderCreated&&api.runProcess)try{api.getPlatform&&"Windows"===api.getPlatform()?api.runProcess("cmd",["/c","mkdir",quiverDir.replace(/\//g,"\\")]):api.runProcess("mkdir",["-p",quiverDir]),finalDir=quiverDir,folderCreated=!0}catch(eCmd){
// Could not create Quiver folder with system command
}return __imageImportCache.__quiverDir=finalDir||assetsDir,__imageImportCache.__quiverDir}catch(e){return null}}function _hashString(s){for(var h=2166136261,i=0;i<s.length;i++)h=(h^=s.charCodeAt(i))+((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))>>>0;return("00000000"+h.toString(16)).slice(-8)}function _saveDataUriToQuiverFolder(dataUri,contextNode){try{if(__imageImportCache[dataUri])return __imageImportCache[dataUri];var m=/^data:([^;]+);base64,(.*)$/i.exec(dataUri);if(!m)return null;var mime=m[1].toLowerCase(),b64=m[2],ext="bin";-1!==mime.indexOf("png")?ext="png":-1!==mime.indexOf("jpeg")||-1!==mime.indexOf("jpg")?ext="jpg":-1!==mime.indexOf("svg")?ext="svg":-1!==mime.indexOf("webp")&&(ext="webp");var dir=_ensureAssetsQuiverFolder();if(!dir){try{var suggest="img_"+_hashString(dataUri.slice(0,120)+"|"+dataUri.length)+"."+ext,saveFn=ui.saveFile||ui.saveFileDialog||ui.selectSaveFile;if(saveFn){var picked=saveFn("Save embedded image as...",suggest);if(picked){var wroteP=!1;try{api.writeEncodedToBinaryFile&&(wroteP=!!api.writeEncodedToBinaryFile(picked,b64))}catch(eW0){wroteP=!1}if(!wroteP)try{api.writeFile&&(api.writeFile(picked,b64,{encoding:"base64"}),wroteP=!0)}catch(eW1){wroteP=!1}if(wroteP)return __imageImportCache[dataUri]=picked,picked}}}catch(eDlg){}
// No Assets/Quiver dir available and user did not pick a path
return null}_hashString(dataUri.slice(0,120)+"|"+dataUri.length);__imageCounter++;var baseName=__lastPatternOrImageName||"img";contextNode&&contextNode.attrs&&contextNode.attrs.id&&(baseName=contextNode.attrs.id);var base=_sanitizeFileComponent(baseName),uniqueName=base;/_\d+$/.test(base)||(uniqueName=base+"_"+__imageCounter);var outPath=dir+"/"+uniqueName+"."+ext,wrote=!1;try{api.writeEncodedToBinaryFile&&(wrote=!!api.writeEncodedToBinaryFile(outPath,b64))}catch(eEnc){wrote=!1}if(!wrote)try{api.writeFile&&(api.writeFile(outPath,b64,{encoding:"base64"}),wrote=!0)}catch(eWF){wrote=!1}return wrote?(__imageImportCache[dataUri]=outPath,outPath):null}catch(e){return null}}function _copyExternalToQuiverFolder(srcPath){try{if(__imageImportCache[srcPath])return __imageImportCache[srcPath];var dir=_ensureAssetsQuiverFolder();if(!dir)return null;var dest=dir+"/"+srcPath.substring(srcPath.lastIndexOf("/")+1);try{api.copyFile&&api.copyFile(srcPath,dest)}catch(eC){return null}return __imageImportCache[srcPath]=dest,dest}catch(e){return null}}function _resolveImageHrefToAsset(href,contextNode){return href&&importImageryEnabled?/^data:/i.test(href)?_saveDataUriToQuiverFolder(href,contextNode):/^file:\/\//i.test(href)?_copyExternalToQuiverFolder(href.replace(/^file:\/\//i,"")):"/"===href[0]?_copyExternalToQuiverFolder(href):null:null}function createImage(node,parentId,vb){if(!importImageryEnabled)return null;var name=node.name||"image",parentName="";if(parentId)try{parentName=api.getNiceName(parentId)||"",__imageNamingContext.parentId=parentId,__imageNamingContext.parentName=parentName}catch(e){}var contextualName=parentName?parentName+"_image":name;try{__lastPatternOrImageName=contextualName}catch(eNm2){}for(var href=node.attrs&&(node.attrs.href||node.attrs["xlink:href"]),savedPath=_resolveImageHrefToAsset(href,node),x=parseFloat(node.attrs.x||"0"),y=parseFloat(node.attrs.y||"0"),w=parseFloat(node.attrs.width||"0"),h=parseFloat(node.attrs.height||"0"),centre=svgToCavalryPosition(x+w/2,y+h/2,vb),id=null,types=["image","bitmap","footage","imageShape","footageShape","imageLayer"],ti=0;ti<types.length&&!id;ti++)try{id=api.create(types[ti],name)}catch(eCT){id=null}var isPlaceholder=!1;id||(id=api.primitive("rectangle",name),isPlaceholder=!0),parentId&&api.parent(id,parentId);try{if(isPlaceholder)try{api.set(id,{"generator.dimensions":[w,h],"position.x":centre.x,"position.y":centre.y})}catch(eR){}else{try{api.set(id,{"position.x":centre.x,"position.y":centre.y})}catch(eP){}var sizeSet=!1;try{api.set(id,{dimensions:[w,h]}),sizeSet=!0}catch(eD0){}if(!sizeSet)try{api.set(id,{"generator.dimensions":[w,h]}),sizeSet=!0}catch(eD1){}}}catch(eSz){}try{if(!isPlaceholder){var setOk=!1,targetVal=savedPath||href||null,assetId=null;if(savedPath&&api.loadAsset)try{assetId=api.loadAsset(savedPath,!1)}catch(eLoad){assetId=null}if(!assetId&&savedPath&&api.importAsset)try{assetId=api.importAsset(savedPath)}catch(eImp){assetId=null}if(assetId){try{api.connect(assetId,"id",id,"image"),setOk=!0}catch(eConImg){setOk=!1}
// Parent the asset under the Quiver group in Assets Window
var quiverGroup=_ensureQuiverAssetGroup();if(quiverGroup&&api.parent)try{api.parent(assetId,quiverGroup)}catch(eParent){
// Could not parent asset to Quiver group
}}if(!setOk&&targetVal)setOk=!!_setFirstSupported(id,"string"==typeof targetVal&&0===targetVal.indexOf("data:")?["uri","image.uri","path","image.path","source","file"]:["path","image.path","source","file","uri","image.uri"],targetVal)}}catch(eLink){}try{var oNum=parseOpacityValue(node.attrs.opacity||node.attrs.style&&extractStyleProperty(node.attrs.style,"opacity"));null===oNum&&(oNum=1),api.set(id,{"material.alpha":Math.round(100*oNum)})}catch(eO){}return applyBlendMode(id,node.attrs),id}
// quiver_utilities_filters.js
function extractFilters(svgCode){for(var m,filters={},re=/<filter[^>]*id=["']([^"']+)["'][^>]*>([\s\S]*?)<\/filter>/g;null!==(m=re.exec(svgCode));)filters[m[1]]=m[2];return filters}function detectBlurAmount(filterContent){if(!filterContent)return null;for(var floodMatch,hasDropShadow=/<feDropShadow[^>]*>/i.test(filterContent),hasOffset=/<feOffset[^>]*>/i.test(filterContent),hasColorMatrix=/<feColorMatrix[^>]*>/i.test(filterContent),hasMorphology=/<feMorphology[^>]*>/i.test(filterContent),hasVisibleFlood=!1,floodRe=/<feFlood[^>]*>/g;null!==(floodMatch=floodRe.exec(filterContent));){var floodOpacity=_gradGetAttr(floodMatch[0],"flood-opacity");if(!floodOpacity||parseFloat(floodOpacity)>0){hasVisibleFlood=!0;break}}if(hasDropShadow||hasOffset&&hasColorMatrix||hasMorphology||hasVisibleFlood)return null;var match=/<feGaussianBlur[^>]*stdDeviation\s*=\s*["']([^"']+)["'][^>]*>/g.exec(filterContent);if(match&&match[1]){if((filterContent.match(/<fe\w+[^>]*>/g)||[]).length>4)return null;var stdDev=parseFloat(match[1]);if(!isNaN(stdDev)&&stdDev>0)return 2*stdDev/3}return null}function createAndAttachBlur(shapeId,amount){try{if(!importEffectsEnabled)return null;var blurId=null;try{blurId=api.create("blurFilter","Blur")}catch(e0){try{blurId=api.create("blur","Blur")}catch(e00){}}if(!blurId)return null;try{api.set(blurId,{amount:[amount,amount]})}catch(eAmtV){try{api.set(blurId,{"amount.x":amount}),api.set(blurId,{"amount.y":amount})}catch(eAxy){}}try{api.connect(blurId,"id",shapeId,"filters")}catch(eC){try{api.connect(blurId,"id",shapeId,"deformers")}catch(eC2){}}try{api.getParent(blurId)||api.parent(blurId,shapeId)}catch(eP){}return blurId}catch(e){return null}}function detectShadowPasses(filterContent){if(!filterContent)return[];for(var ds,passes=[],dropRe=/<feDropShadow[^>]*>/g;null!==(ds=dropRe.exec(filterContent));){var el=ds[0],dx=parseFloat(_gradGetAttr(el,"dx")||"0"),dy=parseFloat(_gradGetAttr(el,"dy")||"0"),stdDev=parseFloat(_gradGetAttr(el,"stdDeviation")||"4"),col=_gradGetAttr(el,"flood-color")||"#000000",a=parseFloat(_gradGetAttr(el,"flood-opacity")||"0.5"),passObj={dx:dx,dy:dy,blur:2*stdDev/3,color:parseColor(col)||"#000000",alpha:isNaN(a)?.5:a,spread:0};passes.push(passObj)}if(passes.length)return passes;for(var mMatch,morphRe=/<feMorphology[^>]*>/g,morphs=[];null!==(mMatch=morphRe.exec(filterContent));)morphs.push({idx:mMatch.index,el:mMatch[0]});function parseValuesFromSegment(seg){for(var cmMatch,off=/<feOffset[^>]*>/g.exec(seg),blu=/<feGaussianBlur[^>]*>/g.exec(seg),cmRe=/<feColorMatrix[^>]*values\s*=\s*"([^"]+)"[^>]*>/g,cm=null;null!==(cmMatch=cmRe.exec(seg));)if(!/in\s*=\s*"SourceAlpha"/i.test(cmMatch[0])){cm=cmMatch;break}var dx=0,dy=0,blur=8/3,alpha=.35,colorHex=null;(off&&(dx=parseFloat(_gradGetAttr(off[0],"dx")||"0"),dy=parseFloat(_gradGetAttr(off[0],"dy")||"0")),blu)&&(blur=2*parseFloat(_gradGetAttr(blu[0],"stdDeviation")||"4")/3);if(cm&&cm[1]){var vals=cm[1].trim().split(/\s+/).map(parseFloat);if(vals&&vals.length>=20){var rAdd=vals[4],gAdd=vals[9],bAdd=vals[14];function clamp01n(v){return Math.max(0,Math.min(1,isNaN(v)?0:v))}if(!isNaN(rAdd)||!isNaN(gAdd)||!isNaN(bAdd)){var r=Math.round(255*clamp01n(rAdd)),g=Math.round(255*clamp01n(gAdd)),b=Math.round(255*clamp01n(bAdd));colorHex="#"+r.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")+b.toString(16).padStart(2,"0")}var aMul=vals[18],aOff=vals[19],aPick=!isNaN(aMul)&&aMul>0?aMul:isNaN(aOff)?alpha:aOff;isNaN(aPick)||(alpha=Math.max(0,Math.min(1,aPick)))}}return{dx:dx,dy:dy,blur:blur,alpha:alpha,color:colorHex}}if(morphs.length>0)for(var i=0;i<morphs.length;i++){var start=morphs[i].idx+morphs[i].el.length,end=i+1<morphs.length?morphs[i+1].idx:filterContent.length,seg=filterContent.slice(start,end),op=(_gradGetAttr(morphs[i].el,"operator")||"").toLowerCase(),r=parseFloat(_gradGetAttr(morphs[i].el,"radius")||"0"),spread=0;"dilate"===op?spread=+Math.max(0,r):"erode"===op&&(spread=-Math.max(0,r));passObj={dx:(vals=parseValuesFromSegment(seg)).dx,dy:vals.dy,blur:vals.blur,color:vals.color||"#000000",alpha:vals.alpha,spread:spread};passes.push(passObj)}else{for(var offsetMatch,offsetRe=/<feOffset[^>]*>/g,offsetMatches=[];null!==(offsetMatch=offsetRe.exec(filterContent));)offsetMatches.push({idx:offsetMatch.index,el:offsetMatch[0]});if(offsetMatches.length>0)for(var oi=0;oi<offsetMatches.length;oi++){start=offsetMatches[oi].idx,end=filterContent.length;var blendRe=/<feBlend[^>]*result\s*=\s*"[^"]*dropShadow[^"]*"[^>]*>/g;blendRe.lastIndex=start;var vals,blendMatch=blendRe.exec(filterContent);if(blendMatch&&(end=blendMatch.index+blendMatch[0].length),(vals=parseValuesFromSegment(seg=filterContent.slice(start,end))).color||0!==vals.dx||0!==vals.dy||vals.blur!==8/3){passObj={dx:vals.dx,dy:vals.dy,blur:vals.blur,color:vals.color||"#000000",alpha:vals.alpha,spread:0};passes.push(passObj)}}else{var hasOffset=/<feOffset[^>]*>/g.test(filterContent),hasColorMatrix=/<feColorMatrix[^>]*>/g.test(filterContent)&&!/<feColorMatrix[^>]*in\s*=\s*"SourceAlpha"/gi.test(filterContent);if(hasOffset||hasColorMatrix){var approx=parseValuesFromSegment(filterContent);if(0!==approx.dx||0!==approx.dy||hasColorMatrix&&approx.color){passObj={dx:approx.dx,dy:approx.dy,blur:approx.blur,color:approx.color||"#000000",alpha:approx.alpha,spread:0};passes.push(passObj)}}}}if(0===passes.length)try{for(var mAll,cmAll=[],cmReAll=/<feColorMatrix[^>]*type\s*=\s*"matrix"[^>]*values\s*=\s*"([^"]+)"[^>]*>/g;null!==(mAll=cmReAll.exec(filterContent));){var cmTag=mAll[0];/in\s*=\s*"SourceAlpha"/i.test(cmTag)||cmAll.push({idx:mAll.index,values:mAll[1],tag:cmTag})}for(var cmi=0;cmi<cmAll.length;cmi++){for(var o,cmBlock=cmAll[cmi],before=filterContent.slice(0,cmBlock.idx),offMatch=null,blurMatch=null,offRe=/<feOffset[^>]*>/g;null!==(o=offRe.exec(before));)offMatch=o;for(var b,blRe=/<feGaussianBlur[^>]*>/g;null!==(b=blRe.exec(before));)blurMatch=b;var dxF=0,dyF=0,blurF=8/3;if(offMatch&&(dxF=parseFloat(_gradGetAttr(offMatch[0],"dx")||"0"),dyF=parseFloat(_gradGetAttr(offMatch[0],"dy")||"0")),blurMatch)blurF=2*parseFloat(_gradGetAttr(blurMatch[0],"stdDeviation")||"4")/3;var valsArr=cmBlock.values.trim().split(/\s+/).map(parseFloat),rAddF=valsArr[4],gAddF=valsArr[9],bAddF=valsArr[14];function c01(v){return Math.max(0,Math.min(1,isNaN(v)?0:v))}var colF="#"+Math.round(255*c01(rAddF)).toString(16).padStart(2,"0")+Math.round(255*c01(gAddF)).toString(16).padStart(2,"0")+Math.round(255*c01(bAddF)).toString(16).padStart(2,"0"),aMulF=valsArr[18],aOffF=valsArr[19];passObj={dx:dxF,dy:dyF,blur:blurF,color:colF,alpha:!isNaN(aMulF)&&aMulF>0?aMulF:isNaN(aOffF)?.35:aOffF,spread:0};passes.push(passObj)}}catch(eFB){}return passes}function createAndAttachDropShadow(shapeId,pass){try{if(!importEffectsEnabled)return null;var nodeId=null;try{nodeId=api.create("dropShadowFilter","Drop Shadow")}catch(e0){}if(!nodeId)try{nodeId=api.create("dropShadow","Drop Shadow")}catch(e00){}if(!nodeId)return null;try{api.set(nodeId,{offset:[pass.dx||0,-(pass.dy||0)]})}catch(e2){}var blurAmt=Math.max(0,pass.blur||0),okAmount=!1;try{api.set(nodeId,{amount:[blurAmt,blurAmt]}),okAmount=!0}catch(eAmtV){}if(!okAmount){try{api.set(nodeId,{"amount.x":blurAmt})}catch(eAx){}try{api.set(nodeId,{"amount.y":blurAmt})}catch(eAy){}}var baseCol=parseColor(pass.color||"#000000")||"#000000",colorSet=(Math.max(0,Math.min(100,Math.round(100*("number"==typeof pass.alpha?pass.alpha:.5)))),colorWithOpacity(baseCol,pass.alpha||.5),!1);try{api.set(nodeId,{shadowColor:baseCol}),colorSet=!0}catch(eCol1){}try{var r=parseInt(baseCol.substring(1,3),16),g=parseInt(baseCol.substring(3,5),16),b=parseInt(baseCol.substring(5,7),16),a=Math.round(255*(pass.alpha||.5));api.set(nodeId,{"shadowColor.r":r}),api.set(nodeId,{"shadowColor.g":g}),api.set(nodeId,{"shadowColor.b":b}),api.set(nodeId,{"shadowColor.a":a})}catch(eComponents){}if(!colorSet)try{var rNorm=parseInt(baseCol.substring(1,3),16)/255,gNorm=parseInt(baseCol.substring(3,5),16)/255,bNorm=parseInt(baseCol.substring(5,7),16)/255;api.set(nodeId,{"shadowColor.r":rNorm}),api.set(nodeId,{"shadowColor.g":gNorm}),api.set(nodeId,{"shadowColor.b":bNorm}),api.set(nodeId,{"shadowColor.a":pass.alpha||.5})}catch(eNorm){}try{api.connect(nodeId,"id",shapeId,"filters")}catch(eC){try{api.connect(nodeId,"id",shapeId,"deformers")}catch(eC2){}}try{api.getParent(nodeId)||api.parent(nodeId,shapeId)}catch(eP){}return nodeId}catch(e){return null}}function _registerChild(parentId,childId){try{if(null==parentId)return;__groupDirectChildren[parentId]||(__groupDirectChildren[parentId]=[]),__groupDirectChildren[parentId].push(childId)}catch(e){}}
// quiver_utilities_masks.js
var __svgMaskMap={};function setMaskContext(maskMap){__svgMaskMap=maskMap||{}}function getMaskDefinition(maskId){return __svgMaskMap[maskId]||null}function createMaskShapeForTarget(maskId,targetShapeId,parentId,vb,model){try{var maskDef=getMaskDefinition(maskId);if(!maskDef)return console.warn("[Quiver] Mask definition not found: "+maskId),null;var maskChild=maskDef.children&&maskDef.children[0];if(!maskChild)return console.warn("[Quiver] Mask has no child elements: "+maskId),null;var maskShapeId=null;if("rect"===maskChild.type)maskShapeId=createRect(maskChild,parentId,vb);else if("circle"===maskChild.type)maskShapeId=createCircle(maskChild,parentId,vb);else if("ellipse"===maskChild.type)maskShapeId=createEllipse(maskChild,parentId,vb);else{if("path"!==maskChild.type)return console.warn("[Quiver] Unsupported mask shape type: "+maskChild.type),null;maskShapeId=createEditableFromPathSegments(parsePathDataToAbsolute(maskChild.attrs.d||""),maskChild.name||"Mask Path",parentId,vb,{x:0,y:0},maskChild.attrs)}if(!maskShapeId)return console.warn("[Quiver] Failed to create mask shape"),null;try{api.set(maskShapeId,{hidden:!0})}catch(eHidden){console.warn("[Quiver] Could not set mask shape as hidden")}if("luminance"===maskDef.type)try{var shiftChannelsId=api.create("shiftChannels","Shift Channels ["+maskChild.name+"]");if(shiftChannelsId){api.set(shiftChannelsId,{aSource:5});try{api.connect(shiftChannelsId,"id",maskShapeId,"filters")}catch(eConn){console.warn("[Quiver] Could not connect ShiftChannels to mask shape")}try{api.getParent(shiftChannelsId)||api.parent(shiftChannelsId,maskShapeId)}catch(eParent){}}}catch(eShift){console.warn("[Quiver] Could not create ShiftChannels filter for luminance mask")}try{api.connect(maskShapeId,"id",targetShapeId,"trackMattes"),console.log("[Quiver] Connected mask "+maskId+" to shape "+api.getNiceName(targetShapeId))}catch(eTrackMatte){console.warn("[Quiver] Could not connect mask as track matte: "+eTrackMatte.message)}return maskShapeId}catch(e){return console.error("[Quiver] Error creating mask shape: "+(e.message||e)),null}}
// quiver_utilities_transform.js
function parseTranslate(transform){if(!transform)return{x:0,y:0};var m=transform.match(/translate\(([^\)]*)\)/);if(m){var parts=m[1].split(/[ ,]+/).map(function(s){return parseFloat(s)});return{x:parts.length>0&&!isNaN(parts[0])?parts[0]:0,y:parts.length>1&&!isNaN(parts[1])?parts[1]:0}}var matrixMatch=transform.match(/matrix\(([^\)]*)\)/);if(matrixMatch){var matrixParts=matrixMatch[1].split(/[ ,]+/).map(function(s){return parseFloat(s)});if(matrixParts.length>=6)return{x:isNaN(matrixParts[4])?0:matrixParts[4],y:isNaN(matrixParts[5])?0:matrixParts[5]}}return{x:0,y:0}}function applyMatrixToPoint(transform,x,y){if(!transform)return{x:x,y:y};var matrixMatch=transform.match(/matrix\(([^\)]*)\)/);if(!matrixMatch)return{x:x,y:y};var parts=matrixMatch[1].split(/[ ,]+/).map(function(s){return parseFloat(s)});if(parts.length<6)return{x:x,y:y};var a=parts[0],b=parts[1],c=parts[2],d=parts[3];return{x:a*x+c*y+parts[4],y:b*x+d*y+parts[5]}}function parseRotatePivot(transform){var out={angle:0,cx:null,cy:null};if(!transform||"string"!=typeof transform)return out;var m=/rotate\(\s*([-\d\.]+)(?:[ ,]+([-\d\.]+)[ ,]+([-\d\.]+))?\s*\)/.exec(transform);if(!m)return out;var ang=parseFloat(m[1]);if(isNaN(ang)||(out.angle=ang),void 0!==m[2]&&void 0!==m[3]){var cx=parseFloat(m[2]),cy=parseFloat(m[3]);isNaN(cx)||isNaN(cy)||(out.cx=cx,out.cy=cy)}return out}function rotatePointAround(x,y,angleDeg,cx,cy){var th=(angleDeg||0)*Math.PI/180,cos=Math.cos(th),sin=Math.sin(th),dx=x-cx,dy=y-cy;return{x:cx+dx*cos-dy*sin,y:cy+dx*sin+dy*cos}}function _matIdentity(){return{a:1,b:0,c:0,d:1,e:0,f:0}}function _matMultiply(m1,m2){return{a:m1.a*m2.a+m1.c*m2.b,b:m1.b*m2.a+m1.d*m2.b,c:m1.a*m2.c+m1.c*m2.d,d:m1.b*m2.c+m1.d*m2.d,e:m1.a*m2.e+m1.c*m2.f+m1.e,f:m1.b*m2.e+m1.d*m2.f+m1.f}}function _matTranslate(tx,ty){return{a:1,b:0,c:0,d:1,e:tx||0,f:ty||0}}function _matScale(sx,sy){return(void 0===sy||isNaN(sy))&&(sy=sx),{a:sx||1,b:0,c:0,d:sy||1,e:0,f:0}}function _matRotate(rad){var cos=Math.cos(rad),sin=Math.sin(rad);return{a:cos,b:sin,c:-sin,d:cos,e:0,f:0}}function _matSkewX(rad){return{a:1,b:0,c:Math.tan(rad),d:1,e:0,f:0}}function _matSkewY(rad){return{a:1,b:Math.tan(rad),c:0,d:1,e:0,f:0}}function _matFrom(a,b,c,d,e,f){return{a:a,b:b,c:c,d:d,e:e,f:f}}function parseTransformMatrixList(str){if(!str||"string"!=typeof str)return _matIdentity();for(var m,regex=/(matrix|translate|scale|rotate|skewX|skewY)\s*\(([^\)]*)\)/g,acc=_matIdentity();null!==(m=regex.exec(str));){var kind=m[1],args=m[2].split(/[ ,]+/).filter(function(s){return""!==s}).map(parseFloat),t=_matIdentity();if("matrix"===kind&&args.length>=6)t=_matFrom(args[0],args[1],args[2],args[3],args[4],args[5]);else if("translate"===kind){t=_matTranslate(args[0]||0,(args.length>1?args[1]:0)||0)}else if("scale"===kind){var sx=args[0]||1;t=_matScale(sx,args.length>1?args[1]:sx)}else if("rotate"===kind){var ang=(args[0]||0)*Math.PI/180;if(args.length>=3){var cx=args[1]||0,cy=args[2]||0;t=_matMultiply(_matMultiply(_matTranslate(cx,cy),_matRotate(ang)),_matTranslate(-cx,-cy))}else t=_matRotate(ang)}else"skewX"===kind?t=_matSkewX((args[0]||0)*Math.PI/180):"skewY"===kind&&(t=_matSkewY((args[0]||0)*Math.PI/180));acc=_matMultiply(acc,t)}return acc}function decomposeMatrix(m){var a=m.a,b=m.b,c=m.c,d=m.d,scaleX=Math.sqrt(a*a+b*b)||0,rot=0;0!==scaleX&&(rot=Math.atan2(b,a));var a2=a/(scaleX||1),b2=b/(scaleX||1),shear=a2*c+b2*d,c2=c-a2*shear,d2=d-b2*shear,scaleY=Math.sqrt(c2*c2+d2*d2)||0;a*d-b*c<0&&(scaleX<scaleY?scaleX=-scaleX:scaleY=-scaleY);var shearFactor=0!==scaleY?shear/scaleY:0,translateX=m.e||m.tx||0,translateY=m.f||m.ty||0;return{rotationDeg:180*rot/Math.PI,scaleX:scaleX,scaleY:scaleY,shear:shearFactor,translateX:translateX,translateY:translateY}}function getRotationDegFromTransform(tstr){return decomposeMatrix(parseTransformMatrixList(tstr||"")).rotationDeg||0}
// quiver_svgParser.js
function parseSVGStructure(svgCode){var uidCounter=0,idIndex={};function makeNode(base){return base._uid=++uidCounter,base.attrs&&base.attrs.id&&(idIndex[base.attrs.id]=base),base}for(var match,tree=makeNode({type:"root",name:"root",children:[],attrs:{},transformChain:[]}),stack=[tree],regex=/<(svg|g|rect|circle|ellipse|text|path|polygon|polyline|line|image|pattern|defs|clipPath|mask|use)([^>]*)>|<\/\s*(svg|g|text|defs|clipPath|mask|pattern)\s*>|<tspan([^>]*)>(.*?)<\/tspan>/g;null!==(match=regex.exec(svgCode));)if(match[1]){var tag=match[1],opening="<"+tag+(match[2]||"")+">";if("svg"===tag||"g"===tag||"text"===tag||"defs"===tag||"clipPath"===tag||"mask"===tag){var node=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],tspans:[],transformChain:[]});node.attrs.transform=extractAttribute(opening,"transform");for(var directAttrs=["id","fill","fill-opacity","stroke","stroke-width","stroke-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","opacity","font-family","font-size","font-weight","font-style","letter-spacing","x","y","mask","clip-path","filter","mix-blend-mode"],d=0;d<directAttrs.length;d++){var key=directAttrs[d],val=extractAttribute(opening,key);null!==val&&(node.attrs[key]=val)}var styleAttr=extractAttribute(opening,"style");styleAttr&&(node.attrs.style=styleAttr);var inline=mergeInlineStyleIntoAttrs(opening);for(var k in inline)node.attrs[k]=inline[k];if(stack[stack.length-1].children.push(node),stack.push(node),"text"===tag)try{var textEndPos=match.index+match[0].length,nextTagMatch=/<[^>]+>/.exec(svgCode.substring(textEndPos));if(nextTagMatch){var directTextContent=svgCode.substring(textEndPos,textEndPos+nextTagMatch.index).trim();if(directTextContent){directTextContent=(directTextContent=directTextContent.replace(/&#10;/g,"")).replace(/<a[^>]*>/g,"").replace(/<\/a>/g,"");try{directTextContent=decodeEntitiesForName(directTextContent)}catch(eDec){}directTextContent&&node.tspans.push({x:parseFloat(node.attrs.x||"0"),y:parseFloat(node.attrs.y||"0"),text:directTextContent})}}}catch(eDirectText){}}else if("rect"===tag||"circle"===tag||"ellipse"===tag){for(var leaf=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],transformChain:[]}),keys=["id","x","y","width","height","rx","ry","cx","cy","r","rx","ry","fill","fill-opacity","stroke","stroke-width","stroke-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","opacity","transform","mask","clip-path","filter","mix-blend-mode"],j=0;j<keys.length;j++){var kk=keys[j],vv=extractAttribute(opening,kk);null!==vv&&(leaf.attrs[kk]=vv)}var inline2=mergeInlineStyleIntoAttrs(opening);for(var k2 in inline2)leaf.attrs[k2]=inline2[k2];stack[stack.length-1].children.push(leaf)}else if("image"===tag){var inode=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],transformChain:[]});null!==(href=extractAttribute(opening,"href")||extractAttribute(opening,"xlink:href"))&&(inode.attrs.href=href);for(var ikeys=["id","x","y","width","height","opacity","transform","preserveAspectRatio","mask","clip-path","filter","mix-blend-mode"],ij=0;ij<ikeys.length;ij++){var ikk=ikeys[ij],ivv=extractAttribute(opening,ikk);null!==ivv&&(inode.attrs[ikk]=ivv)}var inlineI=mergeInlineStyleIntoAttrs(opening);for(var kI in inlineI)inode.attrs[kI]=inlineI[kI];inode.attrs.id&&(idIndex[inode.attrs.id]=inode),stack[stack.length-1].children.push(inode)}else if("use"===tag){var href,unode=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],transformChain:[]});null!==(href=extractAttribute(opening,"href")||extractAttribute(opening,"xlink:href"))&&(unode.attrs.href=href);for(var ukeys=["id","x","y","width","height","opacity","transform","mask","clip-path","filter","mix-blend-mode"],uj=0;uj<ukeys.length;uj++){var ukk=ukeys[uj],uvv=extractAttribute(opening,ukk);null!==uvv&&(unode.attrs[ukk]=uvv)}var inlineU=mergeInlineStyleIntoAttrs(opening);for(var kU in inlineU)unode.attrs[kU]=inlineU[kU];stack[stack.length-1].children.push(unode)}else if("pattern"===tag){for(var pnode=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],transformChain:[]}),pkeys=["id","x","y","width","height","patternUnits","patternContentUnits","patternTransform"],pkj=0;pkj<pkeys.length;pkj++){var pkk=pkeys[pkj],pkv=extractAttribute(opening,pkk);null!==pkv&&(pnode.attrs[pkk]=pkv)}stack[stack.length-1].children.push(pnode),stack.push(pnode)}else if("path"===tag){pnode=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],transformChain:[]}),pkeys=["id","d","fill","fill-opacity","stroke","stroke-width","stroke-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","opacity","transform","fill-rule","clip-rule","mask","clip-path","filter","mix-blend-mode"];for(var pj=0;pj<pkeys.length;pj++){var pk=pkeys[pj],pv=extractAttribute(opening,pk);null!==pv&&(pnode.attrs[pk]=pv)}var inline3=mergeInlineStyleIntoAttrs(opening);for(var k3 in inline3)pnode.attrs[k3]=inline3[k3];stack[stack.length-1].children.push(pnode)}else if("polygon"===tag||"polyline"===tag){for(var vnode=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],transformChain:[]}),vkeys=["id","points","fill","fill-opacity","stroke","stroke-width","stroke-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","opacity","transform","mask","clip-path","filter","mix-blend-mode"],vj=0;vj<vkeys.length;vj++){var vk=vkeys[vj],vv2=extractAttribute(opening,vk);null!==vv2&&(vnode.attrs[vk]=vv2)}var inline4=mergeInlineStyleIntoAttrs(opening);for(var k4 in inline4)vnode.attrs[k4]=inline4[k4];stack[stack.length-1].children.push(vnode)}else if("line"===tag){for(var lnode=makeNode({type:tag,name:decodeEntitiesForName(extractAttribute(opening,"id")||tag),attrs:{},opening:opening,children:[],transformChain:[]}),lkeys=["id","x1","y1","x2","y2","fill","fill-opacity","stroke","stroke-width","stroke-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","opacity","transform","mask","clip-path","filter","mix-blend-mode"],lj=0;lj<lkeys.length;lj++){var lk=lkeys[lj],lv=extractAttribute(opening,lk);null!==lv&&(lnode.attrs[lk]=lv)}var inline5=mergeInlineStyleIntoAttrs(opening);for(var k5 in inline5)lnode.attrs[k5]=inline5[k5];stack[stack.length-1].children.push(lnode)}}else if(match[3]){for(var closingTag=match[3],s=stack.length-1;s>=0;s--)if(stack[s].type===closingTag){stack.splice(s,stack.length-s);break}}else if(void 0!==match[4]){var tspanOpen="<tspan"+(match[4]||"")+">",textContent=(match[5]||"").replace(/&#10;/g,"");textContent=textContent.replace(/<a[^>]*>/g,"").replace(/<\/a>/g,"");try{textContent=decodeEntitiesForName(textContent)}catch(eDec){}for(var target=null,si=stack.length-1;si>=0;si--)if("text"===stack[si].type){target=stack[si];break}target&&target.tspans.push({x:parseFloat(extractAttribute(tspanOpen,"x")||target.attrs.x||"0"),y:parseFloat(extractAttribute(tspanOpen,"y")||target.attrs.y||"0"),text:textContent})}return tree._idIndex=idIndex,tree}function extractMasks(svgCode){for(var match,masks={},maskRegex=/<mask([^>]*)>([\s\S]*?)<\/mask>/g;null!==(match=maskRegex.exec(svgCode));){var maskAttrs=match[1],maskContent=match[2],idMatch=/id\s*=\s*["']([^"']+)["']/.exec(maskAttrs);if(idMatch){var maskId=idMatch[1],maskType="alpha",styleMatch=/style\s*=\s*["']([^"']+)["']/.exec(maskAttrs);if(styleMatch){var styleContent=styleMatch[1];/mask-type\s*:\s*luminance/i.test(styleContent)&&(maskType="luminance")}for(var childMatch,children=[],childRegex=/<(circle|ellipse|rect|path)([^>]*)\/?>(?:[\s\S]*?<\/\1>)?/g;null!==(childMatch=childRegex.exec(maskContent));){var childType=childMatch[1],childOpening="<"+childType+childMatch[2]+">",childNode={type:childType,name:extractAttribute(childOpening,"id")||childType,attrs:{}},attrKeys=[];"circle"===childType?attrKeys=["id","cx","cy","r","fill","fill-opacity","stroke","stroke-width","opacity","transform"]:"ellipse"===childType?attrKeys=["id","cx","cy","rx","ry","fill","fill-opacity","stroke","stroke-width","opacity","transform"]:"rect"===childType?attrKeys=["id","x","y","width","height","rx","ry","fill","fill-opacity","stroke","stroke-width","opacity","transform"]:"path"===childType&&(attrKeys=["id","d","fill","fill-opacity","stroke","stroke-width","opacity","transform","fill-rule"]);for(var i=0;i<attrKeys.length;i++){var key=attrKeys[i],val=extractAttribute(childOpening,key);null!==val&&(childNode.attrs[key]=val)}children.push(childNode)}masks[maskId]={type:maskType,children:children,attrs:{}}}}return masks}function _geomKey(node){if(!node||!node.type)return null;var t=node.type,a=node.attrs||{},tr=a.transform||"";return"path"===t?"p:"+(a.d||"")+"|t:"+tr:"rect"===t?"r:"+[a.x||0,a.y||0,a.width||0,a.height||0,a.rx||0,a.ry||0].join(",")+"|t:"+tr:"circle"===t?"c:"+[a.cx||0,a.cy||0,a.r||0].join(",")+"|t:"+tr:"ellipse"===t?"e:"+[a.cx||0,a.cy||0,a.rx||0,a.ry||0].join(",")+"|t:"+tr:"polygon"===t||"polyline"===t?("polygon"===t?"g:":"l:")+(a.points||"")+"|t:"+tr:"line"===t?"line:"+[a.x1||0,a.y1||0,a.x2||0,a.y2||0].join(",")+"|t:"+tr:null}function _hasFillOnly(attrs){if(!attrs)return!1;var f=attrs.fill,s=attrs.stroke;return f&&"none"!==f&&!(s&&"none"!==s)}function _hasStrokeOnly(attrs){if(!attrs)return!1;var f=attrs.fill,s=attrs.stroke;return!(f&&"none"!==f)&&(s&&"none"!==s)}function mergeFillStrokePairs(node){if(node&&node.children&&node.children.length){for(var buckets={},i=0;i<node.children.length;i++){var ch=node.children[i];"g"!==ch.type&&"svg"!==ch.type&&"root"!==ch.type||mergeFillStrokePairs(ch);var key=_geomKey(ch);key&&(buckets[key]||(buckets[key]=[]),buckets[key].push(ch))}for(var k in buckets){var arr=buckets[k];if(arr&&!(arr.length<2)){for(var fillNode=null,strokeNode=null,j=0;j<arr.length;j++){var n=arr[j];!fillNode&&_hasFillOnly(n.attrs)&&(fillNode=n),!strokeNode&&_hasStrokeOnly(n.attrs)&&(strokeNode=n)}if(fillNode&&strokeNode){var base=fillNode,donor=strokeNode;base.attrs.stroke=donor.attrs.stroke,void 0!==donor.attrs["stroke-width"]&&(base.attrs["stroke-width"]=donor.attrs["stroke-width"]),void 0!==donor.attrs["stroke-opacity"]&&(base.attrs["stroke-opacity"]=donor.attrs["stroke-opacity"]),void 0!==donor.attrs["stroke-dasharray"]&&(base.attrs["stroke-dasharray"]=donor.attrs["stroke-dasharray"]),void 0!==donor.attrs["stroke-dashoffset"]&&(base.attrs["stroke-dashoffset"]=donor.attrs["stroke-dashoffset"]),donor.__remove=!0}}}for(var filtered=[],m=0;m<node.children.length;m++){var ch2=node.children[m];ch2.__remove||filtered.push(ch2)}node.children=filtered;var rectEntries=buildEntries("rect"),ellipseEntries=buildEntries("ellipse");mergeForTypeEntries(rectEntries,"rect"),mergeForTypeEntries(ellipseEntries,"ellipse"),function pruneRemovedRecursively(n){if(n&&n.children){for(var keep=[],ii=0;ii<n.children.length;ii++){var ch=n.children[ii];ch&&!ch.__remove&&keep.push(ch)}n.children=keep;for(var jj=0;jj<n.children.length;jj++)pruneRemovedRecursively(n.children[jj])}}(node)}function nearly(a,b){return Math.abs((parseFloat(a)||0)-(parseFloat(b)||0))<=1}function tryMergeRectPair(fillRect,strokeRect){var fx=parseFloat(fillRect.attrs.x||0),fy=parseFloat(fillRect.attrs.y||0),fw=parseFloat(fillRect.attrs.width||0),fh=parseFloat(fillRect.attrs.height||0),sx=parseFloat(strokeRect.attrs.x||0),sy=parseFloat(strokeRect.attrs.y||0),sw=parseFloat(strokeRect.attrs.width||0),sh=parseFloat(strokeRect.attrs.height||0),w=parseFloat(strokeRect.attrs["stroke-width"]||0);if(!(w>0))return!1;var inner=nearly(sx,fx+w/2)&&nearly(sy,fy+w/2)&&nearly(sw,fw-w)&&nearly(sh,fh-w),outer=nearly(sx,fx-w/2)&&nearly(sy,fy-w/2)&&nearly(sw,fw+w)&&nearly(sh,fh+w);return!(!inner&&!outer)&&(fillRect.attrs.stroke=strokeRect.attrs.stroke,void 0!==strokeRect.attrs["stroke-width"]&&(fillRect.attrs["stroke-width"]=strokeRect.attrs["stroke-width"]),void 0!==strokeRect.attrs["stroke-opacity"]&&(fillRect.attrs["stroke-opacity"]=strokeRect.attrs["stroke-opacity"]),fillRect.attrs._stroke_align=inner?"inner":"outer",strokeRect.__remove=!0,!0)}function tryMergeEllipsePair(fillEl,strokeEl){var fcx=parseFloat(fillEl.attrs.cx||0),fcy=parseFloat(fillEl.attrs.cy||0),frx=parseFloat(fillEl.attrs.rx||0),fry=parseFloat(fillEl.attrs.ry||0),scx=parseFloat(strokeEl.attrs.cx||0),scy=parseFloat(strokeEl.attrs.cy||0),srx=parseFloat(strokeEl.attrs.rx||0),sry=parseFloat(strokeEl.attrs.ry||0),w=parseFloat(strokeEl.attrs["stroke-width"]||0);if(!(w>0))return!1;var inner=nearly(scx,fcx)&&nearly(scy,fcy)&&nearly(srx,frx-w/2)&&nearly(sry,fry-w/2),outer=nearly(scx,fcx)&&nearly(scy,fcy)&&nearly(srx,frx+w/2)&&nearly(sry,fry+w/2);return!(!inner&&!outer)&&(fillEl.attrs.stroke=strokeEl.attrs.stroke,void 0!==strokeEl.attrs["stroke-width"]&&(fillEl.attrs["stroke-width"]=strokeEl.attrs["stroke-width"]),void 0!==strokeEl.attrs["stroke-opacity"]&&(fillEl.attrs["stroke-opacity"]=strokeEl.attrs["stroke-opacity"]),fillEl.attrs._stroke_align=inner?"inner":"outer",strokeEl.__remove=!0,!0)}function buildEntries(kind){for(var out=[],ci=0;ci<node.children.length;ci++){var c=node.children[ci];if(c.type!==kind){if("g"===c.type)if(!(c.attrs&&c.attrs.transform||""))for(var cj=0;cj<c.children.length;cj++){var cc=c.children[cj];cc&&cc.type===kind&&out.push({node:cc,holder:c})}}else out.push({node:c,holder:node})}return out}function mergeForTypeEntries(entries,kind){for(var i=0;i<entries.length;i++){var aEnt=entries[i];if(aEnt&&aEnt.node&&!aEnt.node.__remove){var a=aEnt.node;if(_hasFillOnly(a.attrs))for(var j=0;j<entries.length;j++)if(i!==j){var bEnt=entries[j];if(bEnt&&bEnt.node&&!bEnt.node.__remove){var b=bEnt.node;if(_hasStrokeOnly(b.attrs)){if("rect"===kind?tryMergeRectPair(a,b):tryMergeEllipsePair(a,b))break}}}}}}}function extractViewBox(svg){var m=svg.match(/<svg[^>]*>/);if(!m)return null;var open=m[0],vb=extractAttribute(open,"viewBox"),widthAttr=extractAttribute(open,"width"),heightAttr=extractAttribute(open,"height");if(vb){var vals=vb.split(/[ ,]+/);if(4===vals.length)return{x:parseFloat(vals[0]),y:parseFloat(vals[1]),width:parseFloat(vals[2]),height:parseFloat(vals[3])}}return{x:0,y:0,width:widthAttr?parseFloat((""+widthAttr).replace("px","")):1e3,height:heightAttr?parseFloat((""+heightAttr).replace("px","")):1e3}}function svgToCavalryPosition(xSvg,ySvg,vb){return{x:xSvg-(vb.x+vb.width/2),y:vb.y+vb.height/2-ySvg}}function applyFillAndStroke(layerId,attrs){try{var fill=attrs.fill||attrs.style&&extractStyleProperty(attrs.style,"fill"),fillOpacity=attrs["fill-opacity"]||extractStyleProperty(attrs.style,"fill-opacity"),opacity=attrs.opacity||extractStyleProperty(attrs.style,"opacity"),stroke=attrs.stroke||attrs.style&&extractStyleProperty(attrs.style,"stroke"),strokeWidth=attrs["stroke-width"]||attrs.style&&extractStyleProperty(attrs.style,"stroke-width"),strokeOpacity=attrs["stroke-opacity"]||attrs.style&&extractStyleProperty(attrs.style,"stroke-opacity"),strokeDashArray=attrs["stroke-dasharray"]||attrs.style&&extractStyleProperty(attrs.style,"stroke-dasharray"),strokeDashOffset=attrs["stroke-dashoffset"]||attrs.style&&extractStyleProperty(attrs.style,"stroke-dashoffset"),strokeLinecap=attrs["stroke-linecap"]||attrs.style&&extractStyleProperty(attrs.style,"stroke-linecap"),strokeLinejoin=attrs["stroke-linejoin"]||attrs.style&&extractStyleProperty(attrs.style,"stroke-linejoin"),gradientId=extractUrlRefId(fill),strokeGradientId=extractUrlRefId(stroke);if(fill&&"none"!==fill){api.setFill(layerId,!0);var fo=parseOpacityValue(fillOpacity);null===fo&&(fo=1);var o=parseOpacityValue(opacity);null===o&&(o=1);var effectiveAlpha=clamp01(fo*o);if(gradientId){try{api.set(layerId,{"material.materialColor.a":0})}catch(e0){}try{api.set(layerId,{"material.alpha":Math.round(100*effectiveAlpha)})}catch(e1){}var shaderOk=!1;try{var sh=getGradientShader(gradientId);sh&&(shaderOk=connectShaderToShape(sh,layerId))}catch(eSh){}if(!shaderOk&&__svgPatternMap&&__svgPatternMap[gradientId])try{var pid=gradientId,shaderName="Image Shader";try{var shapeName=api.getNiceName(layerId)||"";if(shapeName&&"Shape"!==shapeName&&"Path"!==shapeName)shaderName=shapeName;else{var parentId=api.getParent(layerId);if(parentId){var parentName=api.getNiceName(parentId)||"";parentName&&(shaderName=parentName)}}shaderName=shaderName+"_"+ ++__imageCounter}catch(eGetName){shaderName="Image Shader "+pid}try{__lastPatternOrImageName=shaderName}catch(eNm){}if(importImageryEnabled){var shaderNode=__patternImageShaderCache[pid]||api.create("imageShader",shaderName);if(shaderNode){var meta=__svgPatternMap[pid]&&__svgPatternMap[pid].image,target=meta&&meta.href?meta.href:null,saved=target?_resolveImageHrefToAsset(target,{attrs:{id:shaderName}}):null,linkVal=saved||target;if(linkVal){var assetId=null;try{saved&&api.loadAsset&&(assetId=api.loadAsset(saved,!1))}catch(eLoad){assetId=null}if(!assetId)try{saved&&api.importAsset&&(assetId=api.importAsset(saved))}catch(eImp){assetId=null}var connected=!1;if(assetId){try{api.connect(assetId,"id",shaderNode,"image"),connected=!0}catch(eConA){connected=!1}try{connected||console.error("[Quiver] Failed to connect asset to imageShader.image")}catch(eLog1){}
// Parent the asset under the Quiver group in Assets Window
var quiverGroup=_ensureQuiverAssetGroup();if(quiverGroup&&api.parent)try{api.parent(assetId,quiverGroup)}catch(eParent){}}if(!connected)_setFirstSupported(shaderNode,["image","generator.image","file","path","source","uri","image.uri","image.path"],linkVal)}try{api.connect(shaderNode,"id",layerId,"material.colorShaders")}catch(eConn){}try{api.getParent(shaderNode)||api.parent(shaderNode,layerId)}catch(ePar){}try{try{_hasAttr(shaderNode,"legacyGraph")&&api.set(shaderNode,{legacyGraph:!1})}catch(eLG){}for(var modes=[4,3,2,1],setDone=!1,mi=0;mi<modes.length&&!setDone;mi++){try{api.set(shaderNode,{scaleMode:modes[mi]}),setDone=!0}catch(eSMA){setDone=!1}if(!setDone)try{api.set(shaderNode,{"generator.scaleMode":modes[mi]}),setDone=!0}catch(eSMB){setDone=!1}}try{api.set(shaderNode,{tilingX:3})}catch(eTX1){try{api.set(shaderNode,{"generator.tilingX":3})}catch(eTX2){}}try{api.set(shaderNode,{tilingY:3})}catch(eTY1){try{api.set(shaderNode,{"generator.tilingY":3})}catch(eTY2){}}var fqOk=!1;try{api.set(shaderNode,{filterQuality:imageFilterQuality}),fqOk=!0}catch(eFQ1){fqOk=!1}if(!fqOk)try{api.set(shaderNode,{"generator.filterQuality":imageFilterQuality})}catch(eFQ2){}_setFirstSupported(shaderNode,["offset","generator.offset"],[0,0])}catch(eAlign){}__patternImageShaderCache[pid]=shaderNode}}else;}catch(eImgPat){}}else{var color=parseColor(fill)||"#000000";api.set(layerId,{"material.materialColor":color,"material.alpha":Math.round(100*effectiveAlpha)})}}else api.setFill(layerId,!1);if(stroke&&"none"!==stroke){api.setStroke(layerId,!0);var scolor=parseColor(stroke)||"#000000",sw=parseFloat((""+(strokeWidth||"1")).replace("px",""));isNaN(sw)&&(sw=1);var so=parseOpacityValue(strokeOpacity);null===so&&(so=1);var o2=parseOpacityValue(opacity);null===o2&&(o2=1);var effA=clamp01(so*o2);if(strokeGradientId){api.set(layerId,{"stroke.strokeColor":scolor,"stroke.strokeColor.a":0,"stroke.width":sw,"stroke.alpha":Math.round(100*effA)});var shStroke=getGradientShader(strokeGradientId);shStroke&&connectShaderToStroke(shStroke,layerId)}else api.set(layerId,{"stroke.strokeColor":scolor,"stroke.width":sw,"stroke.alpha":Math.round(100*effA)});if(strokeLinecap){var capStyle=-1;switch(strokeLinecap.toLowerCase()){case"butt":capStyle=0;break;case"round":capStyle=1;break;case"square":capStyle=2}if(capStyle>=0)try{api.set(layerId,{"stroke.capStyle":capStyle})}catch(eCap){}}if(strokeLinejoin){var joinStyle=-1;switch(strokeLinejoin.toLowerCase()){case"miter":joinStyle=0;break;case"round":joinStyle=1;break;case"bevel":joinStyle=2}if(joinStyle>=0)try{api.set(layerId,{"stroke.joinStyle":joinStyle})}catch(eJoin){}}try{api.set(layerId,{"stroke.dashPatternMode":0})}catch(eDM2){}var csv=normalizeDashArrayToCsv(strokeDashArray);if(csv){try{api.set(layerId,{"stroke.dashPattern":csv})}catch(eDPs){try{api.get(layerId,"stroke.dashPattern")}catch(eGetDP){}try{api.set(layerId,{"stroke.dashPattern":csv})}catch(eDPs2){}}var doff=parseFloat((""+(strokeDashOffset||"0")).replace("px",""));if(!isNaN(doff))try{api.set(layerId,{"stroke.dashOffset":doff})}catch(eDO){}}if(attrs&&attrs._stroke_align){var align=attrs._stroke_align;try{var enumVal=0;"inner"===align?enumVal=1:"outer"===align&&(enumVal=2),api.set(layerId,{"stroke.align":enumVal})}catch(eAlign1){try{var label="inner"===align?"Inner":"outer"===align?"Outer":"Centre";api.set(layerId,{"stroke.align":label})}catch(eAlign2){}}}}else api.setStroke(layerId,!1)}catch(e){}}function createGroup(name,parentId){var id=api.create("group",name);return parentId&&api.parent(id,parentId),id}function _readNumber(tokens,idxObj){var v=parseFloat(tokens[idxObj.i++]);return isNaN(v)&&(v=0),v}function _tokenizePathData(d){if(!d)return[];var norm=d.replace(/,/g," ").replace(/([MmLlHhVvCcSsQqTtAaZz])/g," $1 ").trim();return(norm=norm.replace(/\s+/g," ")).split(" ")}function parsePathDataToAbsolute(d){var tokens=_tokenizePathData(d),iObj={i:0},segments=[],cmd=null,cx=0,cy=0,subx=0,suby=0,prevCpx=null,prevCpy=null,lastCmd=null;function readPoint(rel){var x=_readNumber(tokens,iObj),y=_readNumber(tokens,iObj);return rel&&(x+=cx,y+=cy),{x:x,y:y}}function reflect(px,py,cx0,cy0){return{x:2*cx0-px,y:2*cy0-py}}for(;iObj.i<tokens.length;){var t=tokens[iObj.i++];if(!t)break;if(/^[A-Za-z]$/.test(t)?cmd=t:iObj.i--,!cmd)break;var isRel=cmd===cmd.toLowerCase();switch(cmd.toUpperCase()){case"M":var p=readPoint(isRel);for(segments.push({cmd:"M",x:p.x,y:p.y}),cx=p.x,cy=p.y,subx=p.x,suby=p.y;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var p2=readPoint(isRel);segments.push({cmd:"L",x:p2.x,y:p2.y}),cx=p2.x,cy=p2.y}prevCpx=prevCpy=null,lastCmd="M";break;case"L":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){p=readPoint(isRel);segments.push({cmd:"L",x:p.x,y:p.y}),cx=p.x,cy=p.y}prevCpx=prevCpy=null,lastCmd="L";break;case"H":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var x=_readNumber(tokens,iObj);isRel&&(x+=cx),segments.push({cmd:"L",x:x,y:cy}),cx=x}prevCpx=prevCpy=null,lastCmd="H";break;case"V":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var y=_readNumber(tokens,iObj);isRel&&(y+=cy),segments.push({cmd:"L",x:cx,y:y}),cy=y}prevCpx=prevCpy=null,lastCmd="V";break;case"C":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var cp1=readPoint(isRel),cp2=readPoint(isRel);p=readPoint(isRel);segments.push({cmd:"C",cp1x:cp1.x,cp1y:cp1.y,cp2x:cp2.x,cp2y:cp2.y,x:p.x,y:p.y}),prevCpx=cp2.x,prevCpy=cp2.y,cx=p.x,cy=p.y}lastCmd="C";break;case"S":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var cp1x,cp1y;if("C"===lastCmd||"S"===lastCmd){var refl=reflect(null==prevCpx?cx:prevCpx,null==prevCpy?cy:prevCpy,cx,cy);cp1x=refl.x,cp1y=refl.y}else cp1x=cx,cp1y=cy;cp2=readPoint(isRel),p=readPoint(isRel);segments.push({cmd:"C",cp1x:cp1x,cp1y:cp1y,cp2x:cp2.x,cp2y:cp2.y,x:p.x,y:p.y}),prevCpx=cp2.x,prevCpy=cp2.y,cx=p.x,cy=p.y}lastCmd="S";break;case"Q":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var cp=readPoint(isRel);p=readPoint(isRel);segments.push({cmd:"Q",cpx:cp.x,cpy:cp.y,x:p.x,y:p.y}),prevCpx=cp.x,prevCpy=cp.y,cx=p.x,cy=p.y}lastCmd="Q";break;case"T":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var cpxT,cpyT;if("Q"===lastCmd||"T"===lastCmd){var r=reflect(null==prevCpx?cx:prevCpx,null==prevCpy?cy:prevCpy,cx,cy);cpxT=r.x,cpyT=r.y}else cpxT=cx,cpyT=cy;p=readPoint(isRel);segments.push({cmd:"Q",cpx:cpxT,cpy:cpyT,x:p.x,y:p.y}),prevCpx=cpxT,prevCpy=cpyT,cx=p.x,cy=p.y}lastCmd="T";break;case"A":for(;iObj.i<tokens.length&&!/^[A-Za-z]$/.test(tokens[iObj.i]);){var rx=_readNumber(tokens,iObj),ry=_readNumber(tokens,iObj),xAxisRot=_readNumber(tokens,iObj),largeArc=_readNumber(tokens,iObj),sweep=_readNumber(tokens,iObj);x=_readNumber(tokens,iObj),y=_readNumber(tokens,iObj);isRel&&(x+=cx,y+=cy),segments.push({cmd:"A",rx:rx,ry:ry,phi:xAxisRot,large:!!largeArc,sweep:!!sweep,x:x,y:y}),cx=x,cy=y}prevCpx=prevCpy=null,lastCmd="A";break;case"Z":segments.push({cmd:"Z"}),cx=subx,cy=suby,prevCpx=prevCpy=null,lastCmd="Z";break;default:iObj.i=tokens.length}}return segments}function createEditableFromPathSegments(segments,nodeName,parentId,vb,translate,attrs){var path=new cavalry.Path;function cvt(pt){return svgToCavalryPosition(pt.x+(translate?translate.x:0),pt.y+(translate?translate.y:0),vb)}function arcToCubics(cx0,cy0,rx,ry,phiDeg,largeArc,sweep,x1,y1){var phi=(phiDeg||0)*Math.PI/180,cosPhi=Math.cos(phi),sinPhi=Math.sin(phi),dx2=(cx0-x1)/2,dy2=(cy0-y1)/2,x1p=cosPhi*dx2+sinPhi*dy2,y1p=-sinPhi*dx2+cosPhi*dy2,lam=x1p*x1p/((rx=Math.abs(rx))*rx)+y1p*y1p/((ry=Math.abs(ry))*ry);if(lam>1){var s=Math.sqrt(lam);rx*=s,ry*=s}var rx2=rx*rx,ry2=ry*ry,num=rx2*ry2-rx2*y1p*y1p-ry2*x1p*x1p,den=rx2*y1p*y1p+ry2*x1p*x1p,coef=0===den?0:(largeArc===sweep?-1:1)*Math.sqrt(Math.max(0,num/den)),cxp=coef*(rx*y1p)/ry,cyp=coef*(-ry*x1p)/rx,cx=cosPhi*cxp-sinPhi*cyp+(cx0+x1)/2,cy=sinPhi*cxp+cosPhi*cyp+(cy0+y1)/2;function angle(u,v){var dot=u.x*v.x+u.y*v.y,len=Math.sqrt(u.x*u.x+u.y*u.y)*Math.sqrt(v.x*v.x+v.y*v.y),ang=Math.acos(Math.max(-1,Math.min(1,dot/len)));return u.x*v.y-u.y*v.x<0&&(ang=-ang),ang}var v1={x:(x1p-cxp)/rx,y:(y1p-cyp)/ry},v2={x:(-x1p-cxp)/rx,y:(-y1p-cyp)/ry},theta1=angle({x:1,y:0},v1),delta=angle(v1,v2);!sweep&&delta>0&&(delta-=2*Math.PI),sweep&&delta<0&&(delta+=2*Math.PI);for(var segs=Math.ceil(Math.abs(delta)/(Math.PI/2)),deltaSeg=delta/segs,res=[],i=0;i<segs;i++){var t1=theta1+i*deltaSeg,t2=t1+deltaSeg,cosT1=Math.cos(t1),sinT1=Math.sin(t1),cosT2=Math.cos(t2),sinT2=Math.sin(t2),e1x=cx+(cosPhi*rx*cosT1-sinPhi*ry*sinT1),e1y=cy+(sinPhi*rx*cosT1+cosPhi*ry*sinT1),e2x=cx+(cosPhi*rx*cosT2-sinPhi*ry*sinT2),e2y=cy+(sinPhi*rx*cosT2+cosPhi*ry*sinT2),alpha=4/3*Math.tan((t2-t1)/4),c1x=e1x-alpha*(cosPhi*rx*sinT1+sinPhi*ry*cosT1),c1y=e1y-alpha*(sinPhi*rx*sinT1-cosPhi*ry*cosT1),c2x=e2x+alpha*(cosPhi*rx*sinT2+sinPhi*ry*cosT2),c2y=e2y+alpha*(sinPhi*rx*sinT2-cosPhi*ry*cosT2);res.push({c1x:c1x,c1y:c1y,c2x:c2x,c2y:c2y,ex:e2x,ey:e2y})}return res}for(var i=0;i<segments.length;i++){var s=segments[i];if("M"===s.cmd){var p0=cvt({x:s.x,y:s.y});path.moveTo(p0.x,p0.y)}else if("L"===s.cmd){var p1=cvt({x:s.x,y:s.y});path.lineTo(p1.x,p1.y)}else if("C"===s.cmd){var c1=cvt({x:s.cp1x,y:s.cp1y}),c2=cvt({x:s.cp2x,y:s.cp2y}),pe=cvt({x:s.x,y:s.y});path.cubicTo(c1.x,c1.y,c2.x,c2.y,pe.x,pe.y)}else if("Q"===s.cmd){var cq=cvt({x:s.cpx,y:s.cpy}),pe2=cvt({x:s.x,y:s.y});path.quadTo(cq.x,cq.y,pe2.x,pe2.y)}else if("A"===s.cmd){try{path.boundingBox()}catch(e){}for(var cxCur=null,cyCur=null,j=i-1;j>=0;j--){var pj=segments[j];if("M"===pj.cmd||"L"===pj.cmd||"C"===pj.cmd||"Q"===pj.cmd){cxCur=pj.x,cyCur=pj.y;break}}null===cxCur&&(cxCur=s.x,cyCur=s.y);for(var cubs=arcToCubics(cxCur,cyCur,s.rx,s.ry,s.phi,s.large,s.sweep,s.x,s.y),ci=0;ci<cubs.length;ci++){var cc1=cvt({x:cubs[ci].c1x,y:cubs[ci].c1y}),cc2=cvt({x:cubs[ci].c2x,y:cubs[ci].c2y}),ee=cvt({x:cubs[ci].ex,y:cubs[ci].ey});path.cubicTo(cc1.x,cc1.y,cc2.x,cc2.y,ee.x,ee.y)}}else"Z"===s.cmd&&path.close()}var centre=null;try{var bb=path.boundingBox();bb&&bb.centre&&(centre={x:bb.centre.x,y:bb.centre.y})}catch(eBB){}centre&&path.translate(-centre.x,-centre.y);var id=api.createEditable(path,nodeName||"Path");parentId&&api.parent(id,parentId),centre&&api.set(id,{"position.x":centre.x,"position.y":centre.y}),attrs&&(applyFillAndStroke(id,attrs),applyBlendMode(id,attrs));try{__createdPathLayers.push({id:id,parent:parentId})}catch(eReg){}return id}function createSVGFallbackLayer(node,parentId,vb,translate){var pid=createGroup(node.name||node.type,parentId);if(translate&&(0!==translate.x||0!==translate.y)){var zero=svgToCavalryPosition(0,0,vb),moved=svgToCavalryPosition(translate.x,translate.y,vb);api.set(pid,{"position.x":moved.x-zero.x,"position.y":moved.y-zero.y})}return pid}
// quiver_utilities_shapes.js
function createRect(node,parentId,vb){var x=parseFloat(node.attrs.x||"0"),y=parseFloat(node.attrs.y||"0"),w=parseFloat(node.attrs.width||"0"),h=parseFloat(node.attrs.height||"0"),isBackgroundRect=!1;if(vb&&vb.width&&vb.height){var matchesViewBox=Math.abs(w-vb.width)<.1&&Math.abs(h-vb.height)<.1,atOrigin=Math.abs(x)<.1&&Math.abs(y)<.1,hasGenericName=!node.name||"rect"===node.name||"rectangle"===node.name;isBackgroundRect=matchesViewBox&&atOrigin&&hasGenericName}var name=node.name||"rectangle";isBackgroundRect&&(name="Background");var id=api.primitive("rectangle",name);parentId&&api.parent(id,parentId);var rx=node.attrs.rx?parseFloat(node.attrs.rx):0,ry=node.attrs.ry?parseFloat(node.attrs.ry):0,rxv=isNaN(rx)?0:rx,ryv=isNaN(ry)?0:ry,ryEff=void 0!==node.attrs.ry?ryv:rxv,halfW=w/2,halfH=h/2,ratioX=halfW>0?Math.min(rxv,halfW)/halfW:0,ratioY=halfH>0?Math.min(ryEff,halfH)/halfH:0;if(isFinite(ratioX)&&isFinite(ratioY)&&ratioX>=.95&&ratioY>=.95){try{api.deleteLayer(id)}catch(eDelRect){}var ellipseNode={name:name.replace(/^rect$/,"ellipse"),attrs:{}};ellipseNode.attrs.cx=x+halfW,ellipseNode.attrs.cy=y+halfH,ellipseNode.attrs.rx=halfW,ellipseNode.attrs.ry=halfH;for(var styleKeys=["fill","fill-opacity","stroke","stroke-width","stroke-opacity","opacity","transform","_stroke_align","mix-blend-mode"],si=0;si<styleKeys.length;si++){var k=styleKeys[si];void 0!==node.attrs[k]&&(ellipseNode.attrs[k]=node.attrs[k])}return createEllipse(ellipseNode,parentId,vb)}var rCorner=rxv&&ryv?Math.min(rxv,ryv):rxv||ryv||0,cr=Math.max(0,Math.min(rCorner,Math.min(w,h)/2)),centre=svgToCavalryPosition(x+w/2,y+h/2,vb);api.set(id,{"generator.dimensions":[w,h],"position.x":centre.x,"position.y":centre.y}),cr>0&&api.set(id,{"generator.cornerRadius":cr}),applyFillAndStroke(id,node.attrs),applyBlendMode(id,node.attrs);try{var gradId=extractUrlRefId(node.attrs.fill||node.attrs.style&&extractStyleProperty(node.attrs.style,"fill"));if(gradId){var shader=getGradientShader(gradId);shader&&connectShaderToShape(shader,id)}}catch(eG){}try{var rotPivot=parseRotatePivot(node.attrs&&node.attrs.transform||"");if(rotPivot&&null!==rotPivot.cx&&null!==rotPivot.cy){var newCenterSvg=rotatePointAround(x+w/2,y+h/2,rotPivot.angle,rotPivot.cx,rotPivot.cy),newPos=svgToCavalryPosition(newCenterSvg.x,newCenterSvg.y,vb);api.set(id,{"position.x":newPos.x,"position.y":newPos.y})}}catch(eP){}return id}function createCircle(node,parentId,vb){var name=node.name||"circle",id=api.primitive("ellipse",name);parentId&&api.parent(id,parentId);var cx=parseFloat(node.attrs.cx||"0"),cy=parseFloat(node.attrs.cy||"0"),r=parseFloat(node.attrs.r||"0");api.set(id,{"generator.radius":[r,r]});var pos=svgToCavalryPosition(cx,cy,vb);api.set(id,{"position.x":pos.x,"position.y":pos.y}),applyFillAndStroke(id,node.attrs),applyBlendMode(id,node.attrs);try{var gradId=extractUrlRefId(node.attrs.fill||node.attrs.style&&extractStyleProperty(node.attrs.style,"fill"));if(gradId){var shader=getGradientShader(gradId);shader&&connectShaderToShape(shader,id)}}catch(eG){}try{var rotPivotC=parseRotatePivot(node.attrs&&node.attrs.transform||"");if(rotPivotC&&null!==rotPivotC.cx&&null!==rotPivotC.cy){var newCenterSvgC=rotatePointAround(cx,cy,rotPivotC.angle,rotPivotC.cx,rotPivotC.cy),newPosC=svgToCavalryPosition(newCenterSvgC.x,newCenterSvgC.y,vb);api.set(id,{"position.x":newPosC.x,"position.y":newPosC.y})}}catch(ePc){}return id}function createEllipse(node,parentId,vb){var name=node.name||"ellipse",id=api.primitive("ellipse",name);parentId&&api.parent(id,parentId);var cx=parseFloat(node.attrs.cx||"0"),cy=parseFloat(node.attrs.cy||"0"),rx=parseFloat(node.attrs.rx||"0"),ry=parseFloat(node.attrs.ry||"0");api.set(id,{"generator.radius":[rx,ry]});var pos=svgToCavalryPosition(cx,cy,vb);api.set(id,{"position.x":pos.x,"position.y":pos.y}),applyFillAndStroke(id,node.attrs),applyBlendMode(id,node.attrs);try{var gradId=extractUrlRefId(node.attrs.fill||node.attrs.style&&extractStyleProperty(node.attrs.style,"fill"));if(gradId){var shader=getGradientShader(gradId);shader&&connectShaderToShape(shader,id)}}catch(eG){}try{var rotPivotE=parseRotatePivot(node.attrs&&node.attrs.transform||"");if(rotPivotE&&null!==rotPivotE.cx&&null!==rotPivotE.cy){var newCenterSvgE=rotatePointAround(cx,cy,rotPivotE.angle,rotPivotE.cx,rotPivotE.cy),newPosE=svgToCavalryPosition(newCenterSvgE.x,newCenterSvgE.y,vb);api.set(id,{"position.x":newPosE.x,"position.y":newPosE.y})}}catch(ePe){}return id}function parsePoints(pointsStr){if(!pointsStr)return[];for(var pairs=pointsStr.trim().split(/\s+/),pts=[],i=0;i<pairs.length;i++){var pr=pairs[i].split(",");if(!(pr.length<2)){var x=parseFloat(pr[0]),y=parseFloat(pr[1]);isNaN(x)||isNaN(y)||pts.push({x:x,y:y})}}return pts}function computeCentroid(points){for(var sx=0,sy=0,i=0;i<points.length;i++)sx+=points[i].x,sy+=points[i].y;return{x:sx/points.length,y:sy/points.length}}function analyzePolygon(points){for(var c=computeCentroid(points),radii=[],angles=[],i=0;i<points.length;i++){var dx=points[i].x-c.x,dy=points[i].y-c.y,r=Math.hypot(dx,dy),a=Math.atan2(-dy,dx);radii.push(r),angles.push(a)}var idx=angles.map(function(a,i){return{i:i,a:(a%(2*Math.PI)+2*Math.PI)%(2*Math.PI)}});idx.sort(function(u,v){return u.a-v.a});var sortedR=idx.map(function(o){return radii[o.i]}),n=points.length;if(n<3)return{type:"unknown"};var mean=sortedR.reduce(function(a,b){return a+b},0)/n,dev=Math.sqrt(sortedR.reduce(function(a,b){return a+(b-mean)*(b-mean)},0)/n);if(dev/mean<.05)return{type:"regularPolygon",centroid:c,outerRadius:mean,sides:n};for(var even=[],odd=[],k=0;k<n;k++)(k%2==0?even:odd).push(sortedR[k]);if(even.length>0&&odd.length>0){var me=even.reduce(function(a,b){return a+b},0)/even.length,mo=odd.reduce(function(a,b){return a+b},0)/odd.length,devE=Math.sqrt(even.reduce(function(a,b){return a+(b-me)*(b-me)},0)/even.length),devO=Math.sqrt(odd.reduce(function(a,b){return a+(b-mo)*(b-mo)},0)/odd.length);if(Math.abs(me-mo)/mean>.2&&devE/me<.1&&devO/mo<.1)return{type:"star",centroid:c,outerRadius:Math.max(me,mo),innerRadius:Math.min(me,mo),points:n/2}}return{type:"unknown"}}function createRegularPolygonPrimitive(name,points,parentId,vb,translate,attrs){var analysis=analyzePolygon(points);if("unknown"===analysis.type)return null;if("regularPolygon"===analysis.type&&analysis.sides>=3){var id=api.primitive("polygon",name||"Polygon");parentId&&api.parent(id,parentId);try{api.set(id,{"generator.sides":analysis.sides})}catch(eSides){}try{api.set(id,{"generator.radius":analysis.outerRadius})}catch(eRad){try{api.set(id,{"generator.dimensions":[2*analysis.outerRadius,2*analysis.outerRadius]})}catch(eDim){}}var pos=svgToCavalryPosition(analysis.centroid.x+(translate?translate.x:0),analysis.centroid.y+(translate?translate.y:0),vb);return api.set(id,{"position.x":pos.x,"position.y":pos.y}),attrs&&applyFillAndStroke(id,attrs),id}if("star"===analysis.type&&analysis.points>=3){var id2=api.primitive("star",name||"Star");parentId&&api.parent(id2,parentId);try{api.set(id2,{"generator.points":Math.round(analysis.points)})}catch(ePts){}try{api.set(id2,{"generator.innerRadius":analysis.innerRadius})}catch(eIn){}try{api.set(id2,{"generator.outerRadius":analysis.outerRadius})}catch(eOut){}var pos2=svgToCavalryPosition(analysis.centroid.x+(translate?translate.x:0),analysis.centroid.y+(translate?translate.y:0),vb);return api.set(id2,{"position.x":pos2.x,"position.y":pos2.y}),attrs&&applyFillAndStroke(id2,attrs),id2}return null}
// quiver_utilities_text.js
function parseFontFamilyVariant(fontFamilyStr){if(!fontFamilyStr)return null;var cleaned=fontFamilyStr.replace(/["']/g,"").trim(),hyphenIndex=cleaned.lastIndexOf("-");if(-1===hyphenIndex)return null;var baseName=cleaned.substring(0,hyphenIndex),variant=cleaned.substring(hyphenIndex+1),mappedVariant={Thin:"Thin",UltraLight:"Thin",ExtraLight:"Light",Light:"Light",Regular:"Regular",Medium:"Medium",SemiBold:"SemiBold",Semibold:"SemiBold",DemiBold:"SemiBold",Bold:"Bold",ExtraBold:"ExtraBold",UltraBold:"ExtraBold",Black:"Black",Heavy:"Black",Italic:"Italic",ItalicMT:"Italic",It:"Italic",Oblique:"Italic",BoldItalic:"Bold Italic",BoldItalicMT:"Bold Italic",MediumItalic:"Medium Italic",SemiBoldItalic:"SemiBold Italic",LightItalic:"Light Italic",BlackItalic:"Black Italic"}[variant];return mappedVariant?{family:baseName.replace(/([a-z])([A-Z])/g,"$1 $2"),variant:mappedVariant}:"MT"===variant||variant.match(/^MT$/)?{family:baseName.replace(/([a-z])([A-Z])/g,"$1 $2"),variant:"Regular"}:null}function createText(node,parentId,vb,inheritedScale){try{if(inheritedScale=inheritedScale||{x:1,y:1},!node.tspans||0===node.tspans.length)return null;if(!importLiveTextEnabled)return null;for(var combined="",ti=0;ti<node.tspans.length;ti++){if(ti>0){var prevY=node.tspans[ti-1].y,currY=node.tspans[ti].y;Math.abs(currY-prevY)>1&&(combined+="\n")}combined+=node.tspans[ti].text}try{combined=decodeEntitiesForName(combined)}catch(eDecAll){}var name=combined.split(/\s+/).slice(0,3).join(" ");name||(name=node.name||"text");var id=api.create("textShape",name);parentId&&api.parent(id,parentId);var first=node.tspans[0],pos=svgToCavalryPosition(first.x,first.y,vb),fontSize=(node.attrs.fill||extractStyleProperty(node.attrs.style,"fill"),parseFloat((node.attrs["font-size"]||extractStyleProperty(node.attrs.style,"font-size")||"16").toString().replace("px",""))*((inheritedScale.x+inheritedScale.y)/2)),familyFirst=(node.attrs["font-family"]||extractStyleProperty(node.attrs.style,"font-family")||"Arial").split(",")[0].trim().replace(/["']/g,""),parsed=parseFontFamilyVariant(familyFirst),family=familyFirst,variantFromName=null;parsed?(family=parsed.family,variantFromName=parsed.variant):familyFirst.match(/MT$/)&&(family=familyFirst.replace(/MT$/,""));var weight=node.attrs["font-weight"]||extractStyleProperty(node.attrs.style,"font-weight")||"400",fontStyle=node.attrs["font-style"]||extractStyleProperty(node.attrs.style,"font-style")||"";var finalStyle=variantFromName||(w=(""+weight).toLowerCase(),n=parseInt(w,10),weightStyle=isNaN(n)?"normal"===w?"Regular":"bold"===w?"Bold":w.charAt(0).toUpperCase()+w.slice(1):n<=250?"Thin":n<=350?"Light":n<=450?"Regular":n<=550?"Medium":n<=650?"SemiBold":n<=750?"Bold":n<=850?"ExtraBold":"Black",s=weightStyle||"Regular",-1===(fs=(""+fontStyle).toLowerCase()).indexOf("italic")&&-1===fs.indexOf("oblique")||-1!==s.toLowerCase().indexOf("italic")?s:s+" Italic"),lineSpacingOffset=0;try{var lineHeightRaw=node.attrs["line-height"]||extractStyleProperty(node.attrs.style,"line-height");var defaultLineHeight=1.407*fontSize,lhPx=function(val,fs){if(null==val||""===val)return null;var s=(""+val).trim().toLowerCase();if("normal"===s)return null;if(-1!==s.indexOf("px")){var npx=parseFloat(s.replace("px",""));return isNaN(npx)?null:npx}if(-1!==s.indexOf("%")){var p=parseFloat(s.replace("%",""));return isNaN(p)?null:fs*(p/100)}if(-1!==s.indexOf("em")){var em=parseFloat(s.replace("em",""));return isNaN(em)?null:fs*em}var n=parseFloat(s);return isNaN(n)?null:s===""+n?fs*n:n}(lineHeightRaw,fontSize);if(null!==lhPx&&isFinite(lhPx))lineSpacingOffset=lhPx-defaultLineHeight;else if(node.tspans&&node.tspans.length>1){for(var diffs=[],li=1;li<node.tspans.length;li++){var dy=node.tspans[li].y-node.tspans[li-1].y;isFinite(dy)&&diffs.push(dy)}if(diffs.length>0){for(var sum=0,di=0;di<diffs.length;di++)sum+=diffs[di];var avg=sum/diffs.length;Math.abs(avg)>1&&(lineSpacingOffset=avg-defaultLineHeight)}}}catch(eLS){lineSpacingOffset=0}var textSettings={text:combined,fontSize:fontSize,"font.font":family,"font.style":finalStyle,autoWidth:!0,autoHeight:!0,"position.x":pos.x,"position.y":pos.y,verticalAlignment:3},letterSpacingRaw=node.attrs["letter-spacing"]||extractStyleProperty(node.attrs.style,"letter-spacing"),letterSpacingRatio=null;if(letterSpacingRaw&&"normal"!==(""+letterSpacingRaw).toLowerCase()){var lsStr=(""+letterSpacingRaw).trim(),lsNum=0;-1!==lsStr.indexOf("em")?lsNum=(letterSpacingRatio=parseFloat(lsStr.replace("em","")))*fontSize:-1!==lsStr.indexOf("px")?letterSpacingRatio=(lsNum=parseFloat(lsStr.replace("px","")))/fontSize:(lsNum=parseFloat(lsStr),!isNaN(lsNum)&&Math.abs(lsNum)<10?(letterSpacingRatio=lsNum,lsNum*=fontSize):letterSpacingRatio=lsNum/fontSize),isNaN(lsNum)||0===lsNum||(textSettings.letterSpacing=lsNum)}if(lineSpacingOffset&&node.tspans&&node.tspans.length>1)try{textSettings.lineSpacing=lineSpacingOffset}catch(eSetLS){}if(api.set(id,textSettings),null!==letterSpacingRatio&&!isNaN(letterSpacingRatio)&&0!==letterSpacingRatio)try{api.connect(id,"fontSize",id,"letterSpacing");var expression=letterSpacingRatio.toFixed(6)+"*value";api.setAttributeExpression(id,"letterSpacing",expression)}catch(eExpr){console.log("Note: Could not set letter-spacing expression for "+name)}var attrsForTextStyle={};try{for(var kAT in node.attrs)Object.prototype.hasOwnProperty.call(node.attrs,kAT)&&(attrsForTextStyle[kAT]=node.attrs[kAT])}catch(eCopy){}var fillRawTxt=node.attrs&&(node.attrs.fill||node.attrs.style&&extractStyleProperty(node.attrs.style,"fill"))||null,strokeRawTxt=node.attrs&&(node.attrs.stroke||node.attrs.style&&extractStyleProperty(node.attrs.style,"stroke"))||null,hasStrokeTxt=!(!strokeRawTxt||"none"===(""+strokeRawTxt).toLowerCase()),hasStrokeGradTxt=!!extractUrlRefId(strokeRawTxt),hasStyleFill=!!(node.attrs&&node.attrs.style&&extractStyleProperty(node.attrs.style,"fill")),forceHideFillAlpha=!1;null!=fillRawTxt&&""!==fillRawTxt&&"none"!==(""+fillRawTxt).toLowerCase()||(hasStrokeTxt||hasStrokeGradTxt?(attrsForTextStyle.fill="none",forceHideFillAlpha=!0):hasStyleFill||(attrsForTextStyle.fill="#000000"));try{var srcFill=node.attrs.fill||node.attrs.style&&extractStyleProperty(node.attrs.style,"fill");if(srcFill&&/^rgba\(/i.test(srcFill)){var mA=srcFill.match(/rgba\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\)/i);if(mA&&void 0!==mA[4]){var aVal=clamp01(parseFloat(mA[4])),foNum=parseOpacityValue(node.attrs["fill-opacity"]||node.attrs.style&&extractStyleProperty(node.attrs.style,"fill-opacity"));null===foNum&&(foNum=1),attrsForTextStyle["fill-opacity"]=""+clamp01(foNum*aVal);var rr=parseInt(mA[1]).toString(16).padStart(2,"0"),gg=parseInt(mA[2]).toString(16).padStart(2,"0"),bb=parseInt(mA[3]).toString(16).padStart(2,"0");attrsForTextStyle.fill="#"+rr+gg+bb}}}catch(eRGBA){}if(applyFillAndStroke(id,attrsForTextStyle),applyBlendMode(id,attrsForTextStyle),forceHideFillAlpha)try{api.set(id,{"material.materialColor.a":0})}catch(eHide){}try{var gradIdT=extractUrlRefId(attrsForTextStyle.fill||attrsForTextStyle.style&&extractStyleProperty(attrsForTextStyle.style,"fill"));if(gradIdT){var shaderT=getGradientShader(gradIdT);shaderT&&connectShaderToShape(shaderT,id)}}catch(eGT){}return id}catch(e){return null}var weightStyle,s,fs,w,n}
// quiver_processAndImport.js
function importNode(node,parentId,vb,inheritedTranslate,stats,model,inHiddenDefs,inheritedScale,parentMatrix){inheritedTranslate=inheritedTranslate||{x:0,y:0},inheritedScale=inheritedScale||{x:1,y:1},parentMatrix=parentMatrix||null,inHiddenDefs=!!inHiddenDefs;var nodeT=parseTranslate(node.attrs&&node.attrs.transform);if("g"===node.type||"svg"===node.type||"root"===node.type){if("g"===node.type&&(!node.children||0===node.children.length))return console.log("Skipping empty group:",node.name),null;var rawGroupName=decodeEntitiesForName(node.name||"group"),groupName=rawGroupName;"g"!==node.type||"g"!==rawGroupName&&"group"!==rawGroupName||(groupName="Group "+ ++__groupCounter);var groupScale={x:1,y:1},groupMatrix=null;if(node.attrs&&node.attrs.transform){var decomposed=decomposeMatrix(groupMatrix=parseTransformMatrixList(node.attrs.transform));groupScale.x=decomposed.scaleX,groupScale.y=decomposed.scaleY}var combinedScale={x:inheritedScale.x*groupScale.x,y:inheritedScale.y*groupScale.y},gid=parentId;if("g"===node.type){var tStrG=node.attrs&&node.attrs.transform||"",rotG=getRotationDegFromTransform(tStrG),tXYG=parseTranslate(tStrG),hasStyleG=!(!node.attrs||!(node.attrs.fill||node.attrs.stroke||node.attrs.opacity||node.attrs["fill-opacity"]||node.attrs["stroke-opacity"]||node.attrs.style)),isAnonG="g"===groupName,inheritedFilterForFlatten=function(){try{var fidLocal=extractUrlRefId(node.attrs&&node.attrs.filter);return!fidLocal&&node.attrs&&node.attrs._inheritedFilterId&&(fidLocal=node.attrs._inheritedFilterId),fidLocal||null}catch(e){return null}}();if(isAnonG&&Math.abs(rotG)<1e-4&&Math.abs(tXYG.x)<1e-4&&Math.abs(tXYG.y)<1e-4&&!hasStyleG){var chosenChildIndex=null;if(inheritedFilterForFlatten){for(var ci=0;ci<node.children.length;ci++){var tCh=node.children[ci].type;if("path"===tCh||"rect"===tCh||"circle"===tCh||"ellipse"===tCh||"text"===tCh||"polygon"===tCh||"polyline"===tCh||"line"===tCh){chosenChildIndex=ci;break}}if(null===chosenChildIndex)for(var cj=0;cj<node.children.length;cj++)if("g"===node.children[cj].type){chosenChildIndex=cj;break}}for(var fi=0;fi<node.children.length;fi++)inheritedFilterForFlatten&&fi===chosenChildIndex&&(node.children[fi].attrs||(node.children[fi].attrs={}),node.children[fi].attrs.filter||(node.children[fi].attrs._inheritedFilterId=inheritedFilterForFlatten)),importNode(node.children[fi],parentId,vb,{x:0,y:0},stats,model,!1,inheritedScale,parentMatrix);return parentId}}if("g"===node.type&&node.children&&1===node.children.length){var hasBlendMode=!1;if(node.attrs&&(hasBlendMode=!!(node.attrs["mix-blend-mode"]||node.attrs.style&&extractStyleProperty(node.attrs.style,"mix-blend-mode"))),hasBlendMode){var singleChild=node.children[0];if(singleChild.attrs||(singleChild.attrs={}),node.attrs["mix-blend-mode"]&&(singleChild.attrs["mix-blend-mode"]=node.attrs["mix-blend-mode"]),node.attrs.style){var blendModeFromStyle=extractStyleProperty(node.attrs.style,"mix-blend-mode");blendModeFromStyle&&(singleChild.attrs.style||(singleChild.attrs.style=""),singleChild.attrs["mix-blend-mode"]||extractStyleProperty(singleChild.attrs.style,"mix-blend-mode")||(singleChild.attrs.style=(singleChild.attrs.style?singleChild.attrs.style+"; ":"")+"mix-blend-mode: "+blendModeFromStyle))}node.attrs.opacity&&!singleChild.attrs.opacity&&(singleChild.attrs.opacity=node.attrs.opacity);var childName=(singleChild.name||"").toLowerCase(),parentName=node.name||"";return-1!==["rect","circle","ellipse","path","polygon","polyline","line",""].indexOf(childName)&&!("g"===parentName||"group"===parentName||""===parentName)&&(singleChild.name=parentName),importNode(singleChild,parentId,vb,inheritedTranslate,stats,model,inHiddenDefs,inheritedScale,parentMatrix),parentId}}"svg"!==node.type&&(gid=createGroup(groupName,parentId),stats&&(stats.groups=(stats.groups||0)+1),applyBlendMode(gid,node.attrs));var inheritedFilterId=extractUrlRefId(node.attrs&&node.attrs.filter);if(!inheritedFilterId&&node.attrs&&node.attrs._inheritedFilterId&&(inheritedFilterId=node.attrs._inheritedFilterId),!groupMatrix){var rotDeg=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");if(Math.abs(rotDeg)>1e-4&&null!=gid&&api.set(gid,{rotation:-rotDeg}),(0!==nodeT.x||0!==nodeT.y)&&"root"!==node.type){var zero=svgToCavalryPosition(0,0,vb),moved=svgToCavalryPosition(nodeT.x,nodeT.y,vb);api.set(gid,{"position.x":moved.x-zero.x,"position.y":moved.y-zero.y})}}var childTargets=node.children.slice();if(inheritedFilterId){for(var geomIdxs=[],gi2=0;gi2<childTargets.length;gi2++){var t=childTargets[gi2].type;("path"===t||"rect"===t||"circle"===t||"ellipse"===t||"text"===t||"polygon"===t||"polyline"===t||"line"===t||"image"===t)&&geomIdxs.push(gi2)}for(var chosenIdx=null,gi3=0;gi3<geomIdxs.length;gi3++){var idx=geomIdxs[gi3],nm=(childTargets[idx].name||"")+"";if(/editableShape#\d+/i.test(nm)){chosenIdx=idx;break}if("path"===nm){chosenIdx=idx;break}}if(null===chosenIdx&&geomIdxs.length>0&&(chosenIdx=geomIdxs[0]),null===chosenIdx){for(var wrapperIdx=null,wi=0;wi<childTargets.length;wi++){var ctw=childTargets[wi];if("g"===ctw.type&&ctw.attrs&&(ctw.attrs["clip-path"]||ctw.attrs.clipPath)){wrapperIdx=wi;break}}if(null===wrapperIdx)for(var wj=0;wj<childTargets.length;wj++)if("g"===childTargets[wj].type){wrapperIdx=wj;break}null!==wrapperIdx&&(chosenIdx=wrapperIdx)}for(var ci2=0;ci2<childTargets.length;ci2++){var chN=childTargets[ci2];chN.attrs||(chN.attrs={}),!!extractUrlRefId(chN.attrs.filter)||ci2!==chosenIdx||(chN.attrs._inheritedFilterId=inheritedFilterId)}}var inheritedMaskId=extractUrlRefId(node.attrs&&node.attrs.mask);if(!inheritedMaskId&&node.attrs&&node.attrs._inheritedMaskId&&(inheritedMaskId=node.attrs._inheritedMaskId),inheritedMaskId)for(var mi=0;mi<childTargets.length;mi++){var chM=childTargets[mi];chM.attrs||(chM.attrs={}),!!extractUrlRefId(chM.attrs.mask)||(chM.attrs._inheritedMaskId=inheritedMaskId)}var composedMatrix=groupMatrix;parentMatrix&&groupMatrix?composedMatrix=_matMultiply(parentMatrix,groupMatrix):parentMatrix&&!groupMatrix&&(composedMatrix=parentMatrix);for(var i=0;i<node.children.length;i++)importNode(node.children[i],gid,vb,{x:0,y:0},stats,model,!1,combinedScale,composedMatrix);return gid}if("clipPath"===node.type||"mask"===node.type||"defs"===node.type){for(var i2=0;i2<node.children.length;i2++)importNode(node.children[i2],parentId,vb,{x:0,y:0},stats,model,!0,inheritedScale,parentMatrix);return null}if(inHiddenDefs)return null;if("rect"===node.type){var clone=JSON.parse(JSON.stringify(node)),x=parseFloat(clone.attrs.x||"0"),y=parseFloat(clone.attrs.y||"0"),w=parseFloat(clone.attrs.width||"0"),h=parseFloat(clone.attrs.height||"0");if(node.attrs&&node.attrs.transform&&-1!==node.attrs.transform.indexOf("matrix")){var tl=applyMatrixToPoint(node.attrs.transform,x,y),tr=applyMatrixToPoint(node.attrs.transform,x+w,y),bl=applyMatrixToPoint(node.attrs.transform,x,y+h),br=applyMatrixToPoint(node.attrs.transform,x+w,y+h),minX=Math.min(tl.x,tr.x,bl.x,br.x),maxX=Math.max(tl.x,tr.x,bl.x,br.x),minY=Math.min(tl.y,tr.y,bl.y,br.y),maxY=Math.max(tl.y,tr.y,bl.y,br.y);clone.attrs.x=(minX+inheritedTranslate.x).toString(),clone.attrs.y=(minY+inheritedTranslate.y).toString(),clone.attrs.width=(maxX-minX).toString(),clone.attrs.height=(maxY-minY).toString()}else clone.attrs.x=(x+nodeT.x+inheritedTranslate.x).toString(),clone.attrs.y=(y+nodeT.y+inheritedTranslate.y).toString();var rid=createRect(clone,parentId,vb);_registerChild(parentId,rid);try{var fId=extractUrlRefId(node.attrs&&node.attrs.filter);if(!fId&&node.attrs&&node.attrs._inheritedFilterId&&(fId=node.attrs._inheritedFilterId),fId&&__svgFilterMap&&__svgFilterMap[fId]){var siblings=__groupDirectChildren[parentId]||[];if(!((node.name||"")+"").match(/editableShape#\d+/i)&&siblings.length>0){for(var hasEditableNamed=!1,si0=0;si0<siblings.length;si0++)try{var n0=api.getName(siblings[si0])||"";if(/editableShape#\d+/i.test(n0)){hasEditableNamed=!0;break}}catch(eGN){}hasEditableNamed&&(fId=null)}}if(fId&&__svgFilterMap&&__svgFilterMap[fId]){for(var passes=detectShadowPasses(__svgFilterMap[fId]),pi=0;pi<passes.length;pi++)createAndAttachDropShadow(rid,passes[pi]);var blurAmount=detectBlurAmount(__svgFilterMap[fId]);null!==blurAmount&&createAndAttachBlur(rid,blurAmount)}}catch(eDs){}try{var maskId=extractUrlRefId(node.attrs&&node.attrs.mask);!maskId&&node.attrs&&node.attrs._inheritedMaskId&&(maskId=node.attrs._inheritedMaskId),maskId&&createMaskShapeForTarget(maskId,rid,parentId,vb,model)}catch(eMask){}var rotDegR=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");return Math.abs(rotDegR)>1e-4&&api.set(rid,{rotation:-rotDegR}),stats&&(stats.rects=(stats.rects||0)+1),rid}if("circle"===node.type){var cloneC=JSON.parse(JSON.stringify(node)),cx=parseFloat(cloneC.attrs.cx||"0"),cy=parseFloat(cloneC.attrs.cy||"0");if(node.attrs&&node.attrs.transform&&-1!==node.attrs.transform.indexOf("matrix")){var transformed=applyMatrixToPoint(node.attrs.transform,cx,cy);cloneC.attrs.cx=(transformed.x+inheritedTranslate.x).toString(),cloneC.attrs.cy=(transformed.y+inheritedTranslate.y).toString()}else cloneC.attrs.cx=(cx+nodeT.x+inheritedTranslate.x).toString(),cloneC.attrs.cy=(cy+nodeT.y+inheritedTranslate.y).toString();var cid=createCircle(cloneC,parentId,vb);_registerChild(parentId,cid);try{var fIdC=extractUrlRefId(node.attrs&&node.attrs.filter);if(!fIdC&&node.attrs&&node.attrs._inheritedFilterId&&(fIdC=node.attrs._inheritedFilterId),fIdC&&__svgFilterMap&&__svgFilterMap[fIdC]){for(var passesC=detectShadowPasses(__svgFilterMap[fIdC]),pC=0;pC<passesC.length;pC++)createAndAttachDropShadow(cid,passesC[pC]);var blurAmountC=detectBlurAmount(__svgFilterMap[fIdC]);null!==blurAmountC&&createAndAttachBlur(cid,blurAmountC)}}catch(eDsC){}try{var maskIdC=extractUrlRefId(node.attrs&&node.attrs.mask);!maskIdC&&node.attrs&&node.attrs._inheritedMaskId&&(maskIdC=node.attrs._inheritedMaskId),maskIdC&&createMaskShapeForTarget(maskIdC,cid,parentId,vb,model)}catch(eMaskC){}var rotDegC=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");return Math.abs(rotDegC)>1e-4&&api.set(cid,{rotation:-rotDegC}),stats&&(stats.circles=(stats.circles||0)+1),cid}if("ellipse"===node.type){var cloneE=JSON.parse(JSON.stringify(node));cx=parseFloat(cloneE.attrs.cx||"0"),cy=parseFloat(cloneE.attrs.cy||"0");if(node.attrs&&node.attrs.transform&&-1!==node.attrs.transform.indexOf("matrix")){transformed=applyMatrixToPoint(node.attrs.transform,cx,cy);cloneE.attrs.cx=(transformed.x+inheritedTranslate.x).toString(),cloneE.attrs.cy=(transformed.y+inheritedTranslate.y).toString()}else cloneE.attrs.cx=(cx+nodeT.x+inheritedTranslate.x).toString(),cloneE.attrs.cy=(cy+nodeT.y+inheritedTranslate.y).toString();var eid=createEllipse(cloneE,parentId,vb);_registerChild(parentId,eid);try{var fIdE=extractUrlRefId(node.attrs&&node.attrs.filter);if(!fIdE&&node.attrs&&node.attrs._inheritedFilterId&&(fIdE=node.attrs._inheritedFilterId),fIdE&&__svgFilterMap&&__svgFilterMap[fIdE]){for(var passesE=detectShadowPasses(__svgFilterMap[fIdE]),pE=0;pE<passesE.length;pE++)createAndAttachDropShadow(eid,passesE[pE]);var blurAmountE=detectBlurAmount(__svgFilterMap[fIdE]);null!==blurAmountE&&createAndAttachBlur(eid,blurAmountE)}}catch(eDsE){}try{var maskIdE=extractUrlRefId(node.attrs&&node.attrs.mask);!maskIdE&&node.attrs&&node.attrs._inheritedMaskId&&(maskIdE=node.attrs._inheritedMaskId),maskIdE&&createMaskShapeForTarget(maskIdE,eid,parentId,vb,model)}catch(eMaskE){}var rotDegE=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");return Math.abs(rotDegE)>1e-4&&api.set(eid,{rotation:-rotDegE}),stats&&(stats.ellipses=(stats.ellipses||0)+1),eid}if("text"===node.type){var cloneT=JSON.parse(JSON.stringify(node));if(parentMatrix)for(var k=0;k<cloneT.tspans.length;k++){var origX=cloneT.tspans[k].x,origY=cloneT.tspans[k].y,newX=parentMatrix.a*origX+parentMatrix.c*origY+parentMatrix.e,newY=parentMatrix.b*origX+parentMatrix.d*origY+parentMatrix.f;cloneT.tspans[k].x=newX,cloneT.tspans[k].y=newY}if(node.attrs&&node.attrs.transform&&-1!==node.attrs.transform.indexOf("matrix"))for(k=0;k<cloneT.tspans.length;k++){transformed=applyMatrixToPoint(node.attrs.transform,cloneT.tspans[k].x,cloneT.tspans[k].y);cloneT.tspans[k].x=transformed.x+inheritedTranslate.x,cloneT.tspans[k].y=transformed.y+inheritedTranslate.y}else if(!parentMatrix)for(k=0;k<cloneT.tspans.length;k++)cloneT.tspans[k].x+=nodeT.x+inheritedTranslate.x,cloneT.tspans[k].y+=nodeT.y+inheritedTranslate.y;var tid=createText(cloneT,parentId,vb,inheritedScale);if(!tid)return null;_registerChild(parentId,tid);try{var fIdT=extractUrlRefId(node.attrs&&node.attrs.filter);if(!fIdT&&node.attrs&&node.attrs._inheritedFilterId&&(fIdT=node.attrs._inheritedFilterId),fIdT&&__svgFilterMap&&__svgFilterMap[fIdT]){for(var passesT=detectShadowPasses(__svgFilterMap[fIdT]),pT=0;pT<passesT.length;pT++)createAndAttachDropShadow(tid,passesT[pT]);var blurAmountT=detectBlurAmount(__svgFilterMap[fIdT]);null!==blurAmountT&&createAndAttachBlur(tid,blurAmountT)}}catch(eDsT){}try{var maskIdT=extractUrlRefId(node.attrs&&node.attrs.mask);!maskIdT&&node.attrs&&node.attrs._inheritedMaskId&&(maskIdT=node.attrs._inheritedMaskId),maskIdT&&createMaskShapeForTarget(maskIdT,tid,parentId,vb,model)}catch(eMaskT){}var rotDegT=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");return Math.abs(rotDegT)>1e-4&&api.set(tid,{rotation:-rotDegT}),stats&&(stats.texts=(stats.texts||0)+1),tid}if("image"===node.type){var cloneImg=JSON.parse(JSON.stringify(node));x=parseFloat(cloneImg.attrs.x||"0"),y=parseFloat(cloneImg.attrs.y||"0"),w=parseFloat(cloneImg.attrs.width||"0"),h=parseFloat(cloneImg.attrs.height||"0");if(node.attrs&&node.attrs.transform&&-1!==node.attrs.transform.indexOf("matrix")){tl=applyMatrixToPoint(node.attrs.transform,x,y),tr=applyMatrixToPoint(node.attrs.transform,x+w,y),bl=applyMatrixToPoint(node.attrs.transform,x,y+h),br=applyMatrixToPoint(node.attrs.transform,x+w,y+h),minX=Math.min(tl.x,tr.x,bl.x,br.x),maxX=Math.max(tl.x,tr.x,bl.x,br.x),minY=Math.min(tl.y,tr.y,bl.y,br.y),maxY=Math.max(tl.y,tr.y,bl.y,br.y);cloneImg.attrs.x=(minX+inheritedTranslate.x).toString(),cloneImg.attrs.y=(minY+inheritedTranslate.y).toString(),cloneImg.attrs.width=(maxX-minX).toString(),cloneImg.attrs.height=(maxY-minY).toString()}else cloneImg.attrs.x=(x+nodeT.x+inheritedTranslate.x).toString(),cloneImg.attrs.y=(y+nodeT.y+inheritedTranslate.y).toString();var idImg=createImage(cloneImg,parentId,vb);_registerChild(parentId,idImg);try{var fIdI=extractUrlRefId(node.attrs&&node.attrs.filter);if(!fIdI&&node.attrs&&node.attrs._inheritedFilterId&&(fIdI=node.attrs._inheritedFilterId),fIdI&&__svgFilterMap&&__svgFilterMap[fIdI]){for(var passesI=detectShadowPasses(__svgFilterMap[fIdI]),pI=0;pI<passesI.length;pI++)createAndAttachDropShadow(idImg,passesI[pI]);var blurAmountI=detectBlurAmount(__svgFilterMap[fIdI]);null!==blurAmountI&&createAndAttachBlur(idImg,blurAmountI)}}catch(eDsI){}var rotDegI=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");Math.abs(rotDegI)>1e-4&&api.set(idImg,{rotation:-rotDegI});try{var rotPivotI=parseRotatePivot(node.attrs&&node.attrs.transform||"");if(rotPivotI&&null!==rotPivotI.cx&&null!==rotPivotI.cy){var newCenterSvgI=rotatePointAround(parseFloat(node.attrs.x||0)+parseFloat(node.attrs.width||0)/2,parseFloat(node.attrs.y||0)+parseFloat(node.attrs.height||0)/2,rotPivotI.angle,rotPivotI.cx,rotPivotI.cy),newPosI=svgToCavalryPosition(newCenterSvgI.x,newCenterSvgI.y,vb);api.set(idImg,{"position.x":newPosI.x,"position.y":newPosI.y})}}catch(ePI){}try{var maskIdI=extractUrlRefId(node.attrs&&node.attrs.mask);!maskIdI&&node.attrs&&node.attrs._inheritedMaskId&&(maskIdI=node.attrs._inheritedMaskId),maskIdI&&createMaskShapeForTarget(maskIdI,idImg,parentId,vb,model)}catch(eMaskI){}return stats&&(stats.images=(stats.images||0)+1),idImg}if("use"===node.type){var refId=(node.attrs.href||"").replace("#",""),referencedNode=model._idIndex&&model._idIndex[refId];if(!referencedNode||"image"!==referencedNode.type)return null;var cloneUse=JSON.parse(JSON.stringify(node));cloneUse.type="image";var actualHref=referencedNode.attrs&&(referencedNode.attrs.href||referencedNode.attrs["xlink:href"]);cloneUse.attrs.href=actualHref;x=parseFloat(cloneUse.attrs.x||"0"),y=parseFloat(cloneUse.attrs.y||"0"),w=parseFloat(cloneUse.attrs.width||"0"),h=parseFloat(cloneUse.attrs.height||"0");if(parentMatrix){tl={x:parentMatrix.a*x+parentMatrix.c*y+parentMatrix.e,y:parentMatrix.b*x+parentMatrix.d*y+parentMatrix.f},tr={x:parentMatrix.a*(x+w)+parentMatrix.c*y+parentMatrix.e,y:parentMatrix.b*(x+w)+parentMatrix.d*y+parentMatrix.f},bl={x:parentMatrix.a*x+parentMatrix.c*(y+h)+parentMatrix.e,y:parentMatrix.b*x+parentMatrix.d*(y+h)+parentMatrix.f},br={x:parentMatrix.a*(x+w)+parentMatrix.c*(y+h)+parentMatrix.e,y:parentMatrix.b*(x+w)+parentMatrix.d*(y+h)+parentMatrix.f},minX=Math.min(tl.x,tr.x,bl.x,br.x),maxX=Math.max(tl.x,tr.x,bl.x,br.x),minY=Math.min(tl.y,tr.y,bl.y,br.y),maxY=Math.max(tl.y,tr.y,bl.y,br.y);cloneUse.attrs.x=minX.toString(),cloneUse.attrs.y=minY.toString(),cloneUse.attrs.width=(maxX-minX).toString(),cloneUse.attrs.height=(maxY-minY).toString()}var rectId=api.primitive("rectangle",cloneUse.name||"image");parentId&&api.parent(rectId,parentId),_registerChild(parentId,rectId);x=parseFloat(cloneUse.attrs.x||"0"),y=parseFloat(cloneUse.attrs.y||"0");var centre=svgToCavalryPosition(x+(w=parseFloat(cloneUse.attrs.width||"0"))/2,y+(h=parseFloat(cloneUse.attrs.height||"0"))/2,vb);try{api.set(rectId,{"generator.dimensions":[w,h],"position.x":centre.x,"position.y":centre.y})}catch(eSet){}__imageCounter++;var shaderName=(cloneUse.name||"image")+"_"+__imageCounter,shaderNode=api.create("imageShader",shaderName);if(shaderNode&&actualHref){var saved=_resolveImageHrefToAsset(actualHref,cloneUse),linkVal=saved||actualHref;if(linkVal){var assetId=null;try{saved&&api.loadAsset&&(assetId=api.loadAsset(saved,!1))}catch(eLoad){}if(!assetId)try{saved&&api.importAsset&&(assetId=api.importAsset(saved))}catch(eImp){}if(assetId){try{api.connect(assetId,"id",shaderNode,"image")}catch(eConn){}
// Parent asset under Quiver group
var quiverGroup=_ensureQuiverAssetGroup();if(quiverGroup)try{api.parent(assetId,quiverGroup)}catch(ePar){}}else _setFirstSupported(shaderNode,["image","generator.image","file","path"],linkVal)}try{api.setFill(rectId,!0),api.set(rectId,{"material.materialColor.a":0}),api.connect(shaderNode,"id",rectId,"material.colorShaders"),api.parent(shaderNode,rectId);try{_hasAttr(shaderNode,"legacyGraph")&&api.set(shaderNode,{legacyGraph:!1})}catch(eLG){}try{api.set(shaderNode,{scaleMode:4})}catch(eSM){}try{api.set(shaderNode,{tilingX:3,tilingY:3})}catch(eT){}var fqOk=!1;try{api.set(shaderNode,{filterQuality:imageFilterQuality}),fqOk=!0}catch(eFQ1){fqOk=!1}if(!fqOk)try{api.set(shaderNode,{"generator.filterQuality":imageFilterQuality})}catch(eFQ2){}_setFirstSupported(shaderNode,["offset","generator.offset"],[0,0])}catch(eShader){}}return stats&&(stats.images=(stats.images||0)+1),rectId}if("path"===node.type||"polygon"===node.type||"polyline"===node.type||"line"===node.type){var translateAll={x:nodeT.x+inheritedTranslate.x,y:nodeT.y+inheritedTranslate.y},hasMatrix=node.attrs&&node.attrs.transform&&-1!==node.attrs.transform.indexOf("matrix"),hasParentMatrix=!!parentMatrix;if("line"===node.type){var x1=parseFloat(node.attrs.x1||"0"),y1=parseFloat(node.attrs.y1||"0"),x2=parseFloat(node.attrs.x2||"0"),y2=parseFloat(node.attrs.y2||"0");if(hasParentMatrix){var p1={x:parentMatrix.a*x1+parentMatrix.c*y1+parentMatrix.e,y:parentMatrix.b*x1+parentMatrix.d*y1+parentMatrix.f},p2={x:parentMatrix.a*x2+parentMatrix.c*y2+parentMatrix.e,y:parentMatrix.b*x2+parentMatrix.d*y2+parentMatrix.f};x1=p1.x,y1=p1.y,x2=p2.x,y2=p2.y,translateAll={x:0,y:0}}if(hasMatrix){var t1=applyMatrixToPoint(node.attrs.transform,x1,y1),t2=applyMatrixToPoint(node.attrs.transform,x2,y2);x1=t1.x,y1=t1.y,x2=t2.x,y2=t2.y,hasParentMatrix||(translateAll={x:inheritedTranslate.x,y:inheritedTranslate.y})}_registerChild(parentId,vecId=createEditableFromPathSegments(segments=[{cmd:"M",x:x1,y:y1},{cmd:"L",x:x2,y:y2}],node.name||"Line",parentId,vb,translateAll,node.attrs));try{var fIdL=extractUrlRefId(node.attrs&&node.attrs.filter);if(!fIdL&&node.attrs&&node.attrs._inheritedFilterId&&(fIdL=node.attrs._inheritedFilterId),fIdL&&__svgFilterMap&&__svgFilterMap[fIdL]){for(var passesL=detectShadowPasses(__svgFilterMap[fIdL]),pL=0;pL<passesL.length;pL++)createAndAttachDropShadow(vecId,passesL[pL]);var blurAmountL=detectBlurAmount(__svgFilterMap[fIdL]);null!==blurAmountL&&createAndAttachBlur(vecId,blurAmountL)}}catch(eDsL){}var rotDegL=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");Math.abs(rotDegL)>1e-4&&api.set(vecId,{rotation:-rotDegL});try{var maskIdL=extractUrlRefId(node.attrs&&node.attrs.mask);!maskIdL&&node.attrs&&node.attrs._inheritedMaskId&&(maskIdL=node.attrs._inheritedMaskId),maskIdL&&createMaskShapeForTarget(maskIdL,vecId,parentId,vb,model)}catch(eMaskL){}return stats&&(stats.paths=(stats.paths||0)+1),vecId}if("polygon"===node.type||"polyline"===node.type){var polyPts=parsePoints(node.attrs.points||"");if(hasMatrix&&polyPts){for(pi=0;pi<polyPts.length;pi++){transformed=applyMatrixToPoint(node.attrs.transform,polyPts[pi].x,polyPts[pi].y);polyPts[pi].x=transformed.x,polyPts[pi].y=transformed.y}translateAll={x:inheritedTranslate.x,y:inheritedTranslate.y}}var primId=createRegularPolygonPrimitive(node.name||("polygon"===node.type?"Polygon":"Polyline"),polyPts,parentId,vb,translateAll,node.attrs);if(primId)return stats&&(stats.paths=(stats.paths||0)+1),primId}var vecId,segments=[];if("path"===node.type){if(segments=parsePathDataToAbsolute(node.attrs.d||""),hasParentMatrix){for(var si=0;si<segments.length;si++){if(void 0!==(seg=segments[si]).x&&void 0!==seg.y){newX=parentMatrix.a*seg.x+parentMatrix.c*seg.y+parentMatrix.e,newY=parentMatrix.b*seg.x+parentMatrix.d*seg.y+parentMatrix.f;seg.x=newX,seg.y=newY}if(void 0!==seg.cp1x&&void 0!==seg.cp1y){var newCp1X=parentMatrix.a*seg.cp1x+parentMatrix.c*seg.cp1y+parentMatrix.e,newCp1Y=parentMatrix.b*seg.cp1x+parentMatrix.d*seg.cp1y+parentMatrix.f;seg.cp1x=newCp1X,seg.cp1y=newCp1Y}if(void 0!==seg.cp2x&&void 0!==seg.cp2y){var newCp2X=parentMatrix.a*seg.cp2x+parentMatrix.c*seg.cp2y+parentMatrix.e,newCp2Y=parentMatrix.b*seg.cp2x+parentMatrix.d*seg.cp2y+parentMatrix.f;seg.cp2x=newCp2X,seg.cp2y=newCp2Y}if(void 0!==seg.cpx&&void 0!==seg.cpy){var newCpX=parentMatrix.a*seg.cpx+parentMatrix.c*seg.cpy+parentMatrix.e,newCpY=parentMatrix.b*seg.cpx+parentMatrix.d*seg.cpy+parentMatrix.f;seg.cpx=newCpX,seg.cpy=newCpY}}translateAll={x:0,y:0}}if(hasMatrix){for(si=0;si<segments.length;si++){var seg;if(void 0!==(seg=segments[si]).x&&void 0!==seg.y){transformed=applyMatrixToPoint(node.attrs.transform,seg.x,seg.y);seg.x=transformed.x,seg.y=transformed.y}if(void 0!==seg.x1&&void 0!==seg.y1){t1=applyMatrixToPoint(node.attrs.transform,seg.x1,seg.y1);seg.x1=t1.x,seg.y1=t1.y}if(void 0!==seg.x2&&void 0!==seg.y2){t2=applyMatrixToPoint(node.attrs.transform,seg.x2,seg.y2);seg.x2=t2.x,seg.y2=t2.y}}hasParentMatrix||(translateAll={x:inheritedTranslate.x,y:inheritedTranslate.y})}}else if(polyPts&&polyPts.length){segments.push({cmd:"M",x:polyPts[0].x,y:polyPts[0].y});for(var ppi=1;ppi<polyPts.length;ppi++)segments.push({cmd:"L",x:polyPts[ppi].x,y:polyPts[ppi].y});"polygon"===node.type&&segments.push({cmd:"Z"})}_registerChild(parentId,vecId=createEditableFromPathSegments(segments,node.name||"Path",parentId,vb,translateAll,node.attrs));try{var fIdP=extractUrlRefId(node.attrs&&node.attrs.filter);if(!fIdP&&node.attrs&&node.attrs._inheritedFilterId&&(fIdP=node.attrs._inheritedFilterId),fIdP&&__svgFilterMap&&__svgFilterMap[fIdP]){for(var passesP=detectShadowPasses(__svgFilterMap[fIdP]),pP=0;pP<passesP.length;pP++)createAndAttachDropShadow(vecId,passesP[pP]);var blurAmountP=detectBlurAmount(__svgFilterMap[fIdP]);null!==blurAmountP&&createAndAttachBlur(vecId,blurAmountP)}}catch(eDsP){}var rotDegP=getRotationDegFromTransform(node.attrs&&node.attrs.transform||"");Math.abs(rotDegP)>1e-4&&api.set(vecId,{rotation:-rotDegP});try{var rotPivotP=parseRotatePivot(node.attrs&&node.attrs.transform||"");if(rotPivotP&&null!==rotPivotP.cx&&null!==rotPivotP.cy){var bbp=null;try{bbp=api.getBoundingBox(vecId,!0)}catch(eBB){}if(bbp&&bbp.centre){var guessSvgX=0,guessSvgY=0,countM=0;for(si=0;si<segments.length;si++)"M"===segments[si].cmd&&(guessSvgX+=segments[si].x,guessSvgY+=segments[si].y,countM++);countM>0?(guessSvgX/=countM,guessSvgY/=countM):(guessSvgX=vb.x+vb.width/2+bbp.centre.x,guessSvgY=vb.y+vb.height/2-bbp.centre.y);var newSvgC=rotatePointAround(guessSvgX,guessSvgY,rotPivotP.angle,rotPivotP.cx,rotPivotP.cy),newPosP=svgToCavalryPosition(newSvgC.x,newSvgC.y,vb);api.set(vecId,{"position.x":newPosP.x,"position.y":newPosP.y})}}}catch(ePP){}var gradId2=extractUrlRefId(node.attrs.fill||node.attrs.style&&extractStyleProperty(node.attrs.style,"fill"));if(gradId2){var shader2=getGradientShader(gradId2);shader2&&connectShaderToShape(shader2,vecId)}try{var maskIdP=extractUrlRefId(node.attrs&&node.attrs.mask);!maskIdP&&node.attrs&&node.attrs._inheritedMaskId&&(maskIdP=node.attrs._inheritedMaskId),maskIdP&&createMaskShapeForTarget(maskIdP,vecId,parentId,vb,model)}catch(eMaskP){}return stats&&(stats.paths=(stats.paths||0)+1),vecId}return null}function postProcessMasks(modelRootId,model){}function _safeHasFill(id){try{return api.hasFill(id)}catch(e){return!1}}function _safeHasStroke(id){try{return api.hasStroke(id)}catch(e){return!1}}function _safeGet(id,attr,defv){try{var v=api.get(id,attr);return null==v?defv:v}catch(e){return defv}}function unifyPathStrokePairsAfterImport(){if(__createdPathLayers&&0!==__createdPathLayers.length){for(var byParent={},i=0;i<__createdPathLayers.length;i++){var rec=__createdPathLayers[i];if(rec&&api.layerExists(rec.id)){var p=null==rec.parent?-1:rec.parent;byParent[p]||(byParent[p]=[]),byParent[p].push(rec.id)}}for(var parentKey in byParent){for(var ids=byParent[parentKey],fills=[],strokes=[],j=0;j<ids.length;j++){var lid=ids[j],hasF=_safeHasFill(lid),hasS=_safeHasStroke(lid);hasF&&!hasS?fills.push(lid):!hasF&&hasS&&strokes.push(lid)}if(0!==fills.length&&0!==strokes.length)for(var f=0;f<fills.length;f++){var fid=fills[f],bbF=null;try{bbF=api.getBoundingBox(fid,!0)}catch(eF){}if(bbF){for(var best=null,bestScore=1e9,s=0;s<strokes.length;s++){var sid=strokes[s];if(sid){var bbS=null;try{bbS=api.getBoundingBox(sid,!0)}catch(eS){}if(bbS){var sw=parseFloat(_safeGet(sid,"stroke.width",0));if(sw>0){var dw=bbF.width-bbS.width,dh=bbF.height-bbS.height,cxDiff=Math.abs(bbF.centre.x-bbS.centre.x),cyDiff=Math.abs(bbF.centre.y-bbS.centre.y),tol=Math.max(.5,.15*sw),inner=Math.abs(dw-sw)<=tol&&Math.abs(dh-sw)<=tol,outer=Math.abs(dw+sw)<=tol&&Math.abs(dh+sw)<=tol;if((inner||outer)&&!(cxDiff>tol||cyDiff>tol)){var score=Math.abs(dw)+Math.abs(dh)+cxDiff+cyDiff;score<bestScore&&(best={sid:sid,inner:inner,outer:outer,sw:sw},bestScore=score)}}}}}if(best){try{var scol=_safeGet(best.sid,"stroke.strokeColor","#000000"),sa=_safeGet(best.sid,"stroke.alpha",100);api.setStroke(fid,!0),api.set(fid,{"stroke.strokeColor":scol,"stroke.width":best.sw,"stroke.alpha":sa});var alignEnum=best.inner?1:2;try{api.set(fid,{"stroke.align":alignEnum})}catch(eAlign){}try{api.deleteLayer(best.sid)}catch(eDel){}}catch(eMerge){}for(var s2=0;s2<strokes.length;s2++)if(strokes[s2]===best.sid){strokes[s2]=null;break}}}}}}}function saveSceneBeforeImport(){try{return api.saveScene(),!0}catch(e){return!1}}function processAndImportSVG(svgCode){try{if(!svgCode||""===(svgCode+"").trim())return void console.error("No valid SVG content");if(!svgCode.includes("<svg")||!svgCode.includes("</svg>"))return void console.error("Invalid SVG format");var vb=extractViewBox(svgCode);vb||(vb={x:0,y:0,width:1e3,height:1e3}),__imageCounter=0,__imageNamingContext={},__groupCounter=0;var model=parseSVGStructure(svgCode);try{mergeFillStrokePairs(model)}catch(eMerge){}try{__svgFilterMap=extractFilters(svgCode)||{}}catch(eF){__svgFilterMap={}}try{setPatternContext(extractPatterns(svgCode)||{})}catch(ePatt){setPatternContext({})}try{setMaskContext(extractMasks(svgCode)||{})}catch(eMask){setMaskContext({})}for(var gradientMap={},gradsArr=extractGradients(svgCode),gi=0;gi<gradsArr.length;gi++){var gid=gradsArr[gi].id;gid&&(gradientMap[gid]=gradsArr[gi])}setGradientContext(gradientMap),console.info("Creating layers‚Ä¶");var stats={groups:0,rects:0,circles:0,ellipses:0,texts:0,paths:0};for(var i=0;i<model.children.length;i++)importNode(model.children[i],null,vb,{x:0,y:0},stats,model,!1,{x:1,y:1},null);postProcessMasks(null,model);try{unifyPathStrokePairsAfterImport()}catch(eUP){}console.info("üèπ Import complete ‚Äî groups: "+stats.groups+", rects: "+stats.rects+", circles: "+stats.circles+", ellipses: "+stats.ellipses+", texts: "+stats.texts+", paths: "+stats.paths)}catch(e){var errorMsg=e&&e.message?e.message:"Import failed";"undefined"!==errorMsg&&"null"!==errorMsg&&console.error("Error: "+errorMsg)}}
// quiver_utilities_webserver.js
var QUIVER_PORT=8765,quiverServer=null,Quiver={version:"1.5.2",port:QUIVER_PORT,processAndImportSVG:processAndImportSVG,parseSVGStructure:parseSVGStructure,flattenShape:flattenShape,convertSelectionToRect:convertSelectionToRect,applyDynamicAlignToLayer:applyDynamicAlignToLayer,renameSelectedLayers:renameSelectedLayers,serverRunning:!1};
/**
 * Initialize the Quiver web server
 * Listens for HTTP POST requests from external tools (Figma plugins, etc.)
 */
function initializeQuiverWebServer(){try{if(void 0===api.WebServer)return console.info("üèπ Quiver: Web server requires Cavalry 2.4.0+"),!1;quiverServer=new api.WebServer;var serverCallbacks={onPost:function(){var request,post=quiverServer.getNextPost();try{request=JSON.parse(post.result)}catch(e){return void console.error("üèπ Quiver: Failed to parse request as JSON")}"importSVG"===request.action&&request.svgCode?handleImportSVG(request):"importFromClipboard"===request.action?handleImportFromClipboard(request):"importFromFigma"===request.action&&request.figmaData?handleImportFromFigma(request):"ping"===request.action?handlePing():(console.error("üèπ Quiver: Unknown action '"+(request.action||"none")+"'"),console.error("   Available actions: importSVG, importFromClipboard, importFromFigma, ping"))}};return quiverServer.listen("127.0.0.1",QUIVER_PORT),quiverServer.addCallbackObject(serverCallbacks),quiverServer.setHighFrequency(),Quiver.serverRunning=!0,console.info("üèπ Quiver API server listening on http://127.0.0.1:"+QUIVER_PORT),!0}catch(e){return console.warn("üèπ Quiver: Could not start web server - "+e.message),!1}}function handleImportSVG(request){try{processAndImportSVG(request.svgCode),console.info("üèπ Quiver: SVG imported successfully");try{void 0!==api.raiseWindow?api.raiseWindow():void 0!==api.requestUserAttention&&api.requestUserAttention()}catch(e){}}catch(e){console.error("üèπ Quiver: Import failed - "+e.message)}}function handleImportFromClipboard(request){try{var svg=api.getClipboardText();if(!svg||""===svg.trim())return void console.error("üèπ Quiver: Clipboard is empty");processAndImportSVG(svg),console.info("üèπ Quiver: Clipboard imported successfully")}catch(e){console.error("üèπ Quiver: Clipboard import failed - "+e.message)}}function handleImportFromFigma(request){console.info("üèπ Quiver: Figma import received"),console.info("   Direct Figma import coming soon!"),console.info("   For now, export as SVG from Figma and use importSVG action")}function handlePing(){}function cleanupQuiverWebServer(){try{quiverServer&&Quiver.serverRunning&&("function"==typeof quiverServer.stop&&quiverServer.stop(),quiverServer=null,Quiver.serverRunning=!1,console.info("üèπ Quiver: Web server stopped"))}catch(e){quiverServer=null,Quiver.serverRunning=!1}}Quiver.cleanup=cleanupQuiverWebServer,initializeQuiverWebServer(),ui.show();